#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly CAT='/bin/cat'
readonly GREP='/bin/grep'
readonly LESS='/usr/bin/less'
readonly SED='/bin/sed'

main () {

	local x connections;

	mapfile -t connections < <("$CAT" "${ARGA[@]}" | "$GREP" -Pon 'connect\(\K[0-9]*(?=.*(htons\(3306\)|mysql.sock))');

	if [[ -z "${connections[0]}"  || -n ${ARGA[1]} ]]; then

		cat "${ARGA[@]}" \
			|grep -Po '(write|sendto)\(\d*, "(\W|\d|\w{1,2}(\W|\d))*\K.*", ' \
			| "$SED" -e 's_", $_;_' -e 's/\\r/ /g' -e 's/\\n/ /g' -e 's/\\t/ /g' \
			| "$LESS" -SF

	else

		for x in ${connections[*]}; do

			tail -n +"${x/:*/}" "${ARGA[0]}" \
				| "$GREP" -Po '(write|sendto)\('"${x/*:/}"', "(\W|\d|\w{1,2}(\W|\d))*\K.*", ' \
				| "$SED" -e 's_", $_;_' -e 's/\\r/ /g' -e 's/\\n/ /g' -e 's/\\t/ /g'

		done \
			| "$LESS" -SF

	fi

}

main;

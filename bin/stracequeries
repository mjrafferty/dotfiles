#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
	cat <<- EOF
	This is the usage
EOF
}

main () {

  local x connections;

	if [[ -z "$ARGS" || "$ARGS" =~ --help$|-h$ ]]; then
		_usage;
		return 0;
	fi

	mapfile -t connections < <(cat $ARGS | grep -Pon 'connect\(\K[0-9]*(?=.*(htons\(3306\)|mysql.sock))');

	if [[ -z "$connections"  || -n ${ARGA[1]} ]]; then

		cat $ARGS \
			|grep -Po '(write|sendto)\(\d*, "\\?[^\\]*(\\[^\\]*){3}\\.(\\.)?\K[S,C,U,\(,D,I,R,A][^"]*", ' \
			| sed -e 's_", $_;_' -e 's/\\r/ /g' -e 's/\\n/ /g' -e 's/\\t/ /g' \
			| less -SF

		exit;

	fi

	for x in ${connections[*]}; do

		local file_desc;

		file_desc=(${x/:/ });

		tail -n +"${file_desc[0]}" "${ARGA[0]}" \
			| grep -Po '(write|sendto)\('"${file_desc[1]}"', "\\?[^\\]*(\\[^\\]*){2}\\.(\\.)?\K[^"]*", ' \
			| sed -e 's_", $_;_' -e 's/\\r/ /g' -e 's/\\n/ /g' -e 's/\\t/ /g'

	done \
		| less -SF

}

main;

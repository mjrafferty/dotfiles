#! /usr/bin/env bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly EXCLUDE_RULES="^981176$|^4011015$|^4049";

readonly CAT='/bin/cat'
readonly GREP='/bin/grep'
readonly SORT='/bin/sort'

if grep -q 'release 7' /etc/centos-release; then
  MODGREP=("sudo" "modgrep");
else
  MODGREP=("modgrep");
fi

_usage() {
  "$CAT" <<- EOF

  Prints out mod security rules triggered by the provided
  unique id.

  Usage:  modsecrules < unique id >

EOF
}

main () {
  if [[ -z "$ARGS" ||  "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  "${MODGREP[@]}" -s "${ARGA[0]}" -f /var/log/httpd/modsec_audit.log \
    | "$GREP" -Po '.*\[id[^"]*"\K[0-9]*'  \
    | "$SORT" -u \
    | "$GREP" -Ev "$EXCLUDE_RULES";

}

main;

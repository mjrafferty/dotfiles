#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly EXCLUDE_RULES="^981176$|^4011015$|^4049";

_usage() {
  cat <<- EOF

  Prints out mod security rules triggered by the provided
  unique id.

  Usage:  modsecrules < unique id >

EOF
}

main () {
  if [[ -z "$ARGS" ||  "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  modgrep -s "${ARGA[0]}" -f /var/log/httpd/modsec_audit.log \
    | grep -Po '.*\[id[^"]*"\K[0-9]*'  \
    | sort -u \
    | grep -Ev "$EXCLUDE_RULES";

}

main;

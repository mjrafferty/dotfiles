#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
	cat <<- EOF
	This is the usage
EOF
}

_cmdline() {

	local x;

	for x in ${ARGA[*]}; do

		local delim=""

		case "$x" in
			"--help"|"-h")
				args="${args}-h "
				;;
			*) [[ "${x:0:1}" == "-" ]] || delim="\"";
				args="${args}${delim}${x}${delim} "
				;;
		esac

	done


	echo "$args";
}

_humanReadable() {
	awk '{ H=$1;
	$1="";
	if ( H >= 1073741824  )
		{
			H=H/1024/1024/1024;
			printf "%.1fG\t%s\n",H,$0
		}
	else if ( H >= 1048576  )
		{
			H=H/1024/1024;
			printf "%.1fM\t%s\n",H,$0
		}
	else if ( H >= 1024  )
		{
			H=H/1024;
			printf "%.1fK\t%s\n",H,$0
		}
	else
		{
			printf "%.0fB\t%s\n",H,$0
		}
	}';
}

main () {

	local maldetpid scanpid scanlist filecount clamdpid;

	while getopts "hxt:c:" OPTION "$(_cmdline)"; do

		case $OPTION in
			h)
				_usage;
				exit 0;
				;;
		esac

	done

	filepath="${ARGA[0]}";
  echo "$filepath";

	maldet -a "$filepath" >/dev/null &

	maldetpid=$!;
	echo "nksirpid = $maldetpid";

	sleep 1;

	pgrep -fln "maldet \-a.*$filepath";
	scanpid=$(pgrep -fn "maldet \-a.*$filepath");
	echo "scanpid= $scanpid";

	scanlist="/usr/local/maldetect/tmp/.find.$scanpid"
	echo "scanlist = $scanlist";
	cp "$scanlist" ~/scanlist

	filecount=$(grep -c "$filepath" "$scanlist");
	echo "filecount = $filecount";

	totalsize="$(xargs du -sb < "$scanlist" | awk '{sum +=$1} END {print sum}')";
	_humanReadable "$totalsize";

	sleep 1;

	clamdpid=$(pgrep -u clamav clamd);
	echo "clamdpid = $clamdpid";

	while [ -d /proc/"$scanpid" ]; do

		local currentfile currentfilenumber;

		currentfile=$(lsof -p "$clamdpid" -ad1-99 | grep -o "$filepath.*"| tail -n1);
		echo -e "\tcurentfile = $currentfile";

		[[ -n "$currentfile" ]] && currentfilenumber=$(grep -n "${currentfile}$" "$scanlist" | cut -d: -f1)
		echo -e "\tcurrentfilenumber = $currentfilenumber";

		printf "%s\n\n" $((100 * currentfilenumber/filecount));
		sleep 1;

	done

}

main;

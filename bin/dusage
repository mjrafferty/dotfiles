#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_humanReadable() {
  awk '{ H=$1;
  $1="";
  if ( H >= 1073741824  )
    {
      H=H/1024/1024/1024;
      printf "%.1fG\t%s\n",H,$0
    }
  else if ( H >= 1048576  )
    {
      H=H/1024/1024;
      printf "%.1fM\t%s\n",H,$0
    }
  else if ( H >= 1024  )
    {
      H=H/1024;
      printf "%.1fK\t%s\n",H,$0
    }
  else
    {
      printf "%.0fB\t%s\n",H,$0
    }
  }';
}

_files () {

  printf "\n----- Large Files ------\n";

  find . \
    -path './var/*/mail' -prune -o \
    -size +100M \
    -group "$(getusr)" \
    -type f \
    -exec du -sh {} + | sort -hr | head -20

}

_directories () {

  local temp_list directories;

  temp_list=$(mktemp);

  find . \
    -mindepth 4 \
    -maxdepth 4 \
    -path '*/var/*/mail/*' -prune -o
    -type d \
    -group "$(getusr)" \
    -exec du -sb {} + >> "$temp_list" &

  directories=$(find . \
    -maxdepth 3 \
    -path "./var/*/mail" -prune -o \
    -type d \
    -print);

  printf "\n----- Large Directories ------\n";

  IFS=$'\n'
  for x in $directories; do
    find "$x" -mindepth 1 -maxdepth 1 -group "$(getusr)" -type f -exec du -sb {} + \
      | awk '{sum += $1} END {print sum,dirname}' dirname="$x" >> "$temp_list" &
  done;

  wait;

  sort -k1nr "$temp_list" \
    | head -n20 \
    | _humanReadable;

  rm "$temp_list"

}

_mailboxes () {

  printf "\n----- Large Mailboxes ------\n";

  cd var || return 1;

  find ./*/mail/* \
    -maxdepth 0 \
    -type d \
    -group "$(getusr)"\
    -exec du -sh {} + | sort -hr | head -10
}

_extraStuff() {

  printf "\n----- Extra Stuff ------\n";

  find /home/{tmp,nex*} -maxdepth 3 -group "$(pwd | grep -Po "/home/\K[^/]*")" -exec du -sh {} + \
    | sort -hr \
    | head -n2
}

_deletedFiles() {

  printf "\n----- Deleted Files ------\n";

  lsof -u "$(getusr)" \
    | awk '/deleted/ {print $7,$9,$1,$2}' \
    | sort -hr \
    | _humanReadable \
    | column -t
}

main () {

  cd /home/"$(getusr)" || return 1;

  local func_list tmp_list x;

  declare -a func_list;
  declare -a tmp_list;

  func_list=(_files _directories _mailboxes _extraStuff _deletedFiles);

  for ((x=0;x<${#func_list[@]};x++)); do
    tmp_list[x]="$(mktemp)";
    "${func_list[x]}" 2> /dev/null > "${tmp_list[x]}" &
  done

  wait;

  for ((x=0;x<${#tmp_list[@]};x++)); do
    cat "${tmp_list[x]}";
    rm "${tmp_list[x]}";
  done

  echo;

}

main;


#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_files () {

  printf "\n----- Large Files ------\n";

  find . \
    -mindepth 1 \
    -path "./var/*/mail" -prune -o \
    -size +100M \
    -group "$(getusr)" \
    -exec du -sh {} + | sort -hr | head -20

}

_directories () {

  local temp_list directories;

  temp_list=$(mktemp);
  find . -mindepth 4 -maxdepth 4 -type d -group "$(getusr)" -exec du -s {} + >> "$temp_list" &

  directories=($(find . \
    -mindepth 1 \
    -maxdepth 3 \
    -path "./var/*/mail" -prune -o \
    -type d ));

  printf "\n----- Large Directories ------\n";

  for x in ${directories[*]}; do
    find "$x" -mindepth 1 -maxdepth 1 -group "$(getusr)" -type f -exec du -s {} + \
      | awk '{sum += $1} END {print sum,dirname}' dirname="$x" >> "$temp_list" &
  done;

  wait;

  sort -k1nr "$temp_list" \
    | head -n20 \
    | awk '{ H=$1; if ( H > 1048576  ){ H=H/1024/1024;printf "%.1fG\t%s\n",H,$2  }else{ H=H/1024;printf "%.0fM\t%s\n",H,$2 } }';

  rm "$temp_list"

}

_mailboxes () {

  printf "\n----- Large Mailboxes ------\n";

  cd var || return 1;

  find ./*/mail/* \
    -maxdepth 0 \
    -type d \
    -group "$(getusr)"\
    -exec du -sh {} + | sort -hr | head -10
}

_extraStuff() {

  printf "\n----- Extra Stuff ------\n";

  find /home/{tmp,nex*} -maxdepth 3 -group "$(pwd | grep -Po "/home/\K[^/]*")" -exec du -sh {} + \
    | sort -hr \
    | head -n2
}

_deletedFiles() {

  printf "\n----- Deleted Files ------\n";

  lsof -u "$(getusr)" \
    | awk '/deleted/ {print $7,$9,$1,$2}' \
    | sort -hr \
    | column -t
}

main () {

  cd /home/"$(getusr)" || return 1;

  large_files_tmp=$(mktemp);
  large_dirs_tmp=$(mktemp);
  large_mail_tmp=$(mktemp);
  extras_tmp=$(mktemp);
  deleted_tmp=$(mktemp);

  _files > "$large_files_tmp" &

  _directories > "$large_dirs_tmp" &

  _mailboxes > "$large_mail_tmp" &

  _extraStuff > "$extras_tmp" &

  _deletedFiles > "$deleted_tmp" &

  wait;

  cat "$large_files_tmp";

  cat "$large_dirs_tmp";

  cat "$large_mail_tmp";

  cat "$extras_tmp";

  cat "$deleted_tmp";

  echo;

  rm "$large_files_tmp" "$large_dirs_tmp" "$large_mail_tmp" "$extras_tmp" "$deleted_tmp";

}

main;


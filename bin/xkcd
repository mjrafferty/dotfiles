#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF

  Usage: xkcd [-l <length>]

EOF
}

main () {

  if [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local wordList wordLength n word len rnd

  if [ -r /usr/local/interworx/lib/dict/words ]; then

    wordList='/usr/local/interworx/lib/dict/words';

  elif [ -r /usr/share/dict/words ]; then

    wordList='/usr/share/dict/words';

  else
    echo "No word list found.";
    return 1;
  fi


  if [[ ${ARGA[0]} =~ -l ]]; then

    wordLength=$(( (ARGA[1] - 4) / 4 ));

  else

    wordLength="4,8";

  fi


  if [[ -x /usr/bin/shuf ]]; then

    echo $(shuf -n1000 $wordList | grep -E "^[a-z]{$wordLength}$" | shuf -n4 )$(( (RANDOM % 9000) + 1000 )) \
      | sed 's/\b\([a-zA-Z]\)/\u\1/g' \
      | sed 's/ //g'

  else

    n=0;  word=(); len=$(wc -l < $wordList)

    while [[ $n -lt 4 ]]; do

      rnd=$(( ( $(od -vAn -N4 -tu4 < /dev/urandom) )%(len)+1 ));

      word[$n]=$(sed -n "${rnd}p" $wordList | grep -E "^[a-z]{4,8}$" | sed 's:\b\(.\):\u\1:');

      if [[ -n ${word[$n]} ]]; then

        n=$n+1;

      fi;

    done;

    echo "${word[0]}${word[1]}${word[2]}${word[3]}$(( RANDOM % 9000 + 1000 ))";

  fi

}

main;

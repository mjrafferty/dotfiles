#! /bin/bash

## Watch connections to server, and the IPs those connections are coming from


readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

main () {

  if [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  if ss -ant | grep -q "ffff.*:80"; then # Pseudo IPv6

    if [[ ${ARGA[0]} =~ -q ]]; then # Established Connections

      ss -ant \
        | awk -F: '/EST.*ffff.*:80/{print $4,"<--",$8}'

    else # Verbose (EST and WAIT Connections)

      ss -ant \
        | awk -F: '/ffff.*:80/{print $4,"<--",$8}'

    fi
  else # IPv4

    if [[ ${ARGA[0]} =~ -q ]]; then # Established Connections

      ss -ant \
        | awk '/EST/ && ($4 ~ /:80/) && !/*/ {print $4,"<--",$5}' \
        | sed 's/:80//g; s/:.*$//g'

    else # Verbose (EST and WAIT Connections)

      ss -ant \
        | awk '($4 ~ /:80/) && !/*/ {print $4,"<--",$5}' \
        | sed 's/:80//g; s/:.*$//g'

    fi
  fi \
    | column -t \
    | sort \
    | uniq -c \
    | sort -rn

}

main;

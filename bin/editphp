#! /bin/bash

# Script Arguments
readonly ARGS="$*"
readonly ARGA=("$@")

# Alias executables to prevent PATH issues
alias find='/bin/find'
alias grep='/bin/grep'
alias head='/usr/bin/head'

# Print usage
_usage() {
  cat <<- EOF

Opens the PHP-FPM pool configuration file for a user. Can be
run with no arguments from anywhere in a user's home directory, or
by specifying a user with the -u flag.

Options:

  -u  --user    Edit file for specified user

  -h  --help    Prints this message

EOF
}

# Convert long command line options into short ones for getopts
_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      "--user"|"-u")
        args="${args}-u "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done


  echo "$args";
}

# Main
main () {

  local conf_file user;

  while getopts "hu:" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
      u)
        user="$OPTARG"
        ;;
      *);;
    esac

  done

  [[ -n "$user" ]] || user="$(pwd | grep -Po "home/\K[^\/]*")";

  conf_file="$(find {/opt/nexcess/php*/root,}/etc/php-fpm.d/ -name "${user}.conf" | head -n1)";

  if [[ -z "$conf_file" ]]; then
    echo "Config file not found for $user";
    exit 1;
  fi

  $EDITOR "$conf_file";

  echo "$conf_file";

}

main;

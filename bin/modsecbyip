#! /bin/bash

IP="$1";

if [ -z "$IP" ]; then
  echo "No IP address provided";
else

  # Grab necessary data from log
  logentries=$(sed -n 's/.*'"$IP"'.*\[uri \"\([^"]*\).*unique_id \"\([^"]*\).*/\2\t\1/p' error.log);

  # Find unique uris
  uris=($(echo "$logentries" | cut -f2 | cut -d/ -f1-4 | sort -u ));


  echo "<IfModule mod_security2.c>";
  # Print LocationMatch block for each uri
  for ((i=0;i<${#uris[@]};i++)); do

    uniqueid=($(echo "$logentries" | grep "${uris[$i]}"| cut -f1));

    echo "  <LocationMatch ${uris[$i]} >";
    echo "    # Ticket ID: "
    for ((x=0;x<${#uniqueid[@]};x++)); do

      modsecrules "${uniqueid[$x]}";

    done \
      | sort -u \
      | sed 's/^/    SecRuleRemoveById /';

    echo "  </LocationMatch>";
    unset uniqueid;

  done;
  echo "</IfModule>";
fi

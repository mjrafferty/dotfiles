#! /bin/bash

IP="$1";

if [ -z "$IP" ]; then
  echo "No IP address provided";
else

  logentries=$(sed -n 's/.*'"$IP"'.*\[uri \"\([^"]\).*unique_id \"\([^"]*\).*/\2\t\1/p' error.log);
  uniqueid=($(echo "$logentries" | cut -f1));
  rawuris=($(echo "$logentries" | cut -f2 | sort -u ));

  uris=(${rawuris[0]});

  for ((i=1;i<${#rawuris[@]};i++)); do
    break;
  done

  for ((i=0;i<${#uris[@]};i++)); do
    for ((x=0;x<${#uniqueid[@]};x++)); do
      modsecrules "${uniqueid[$i]}";
    done \
      | sort -u \
      | sed 's/^/SecRuleRemoveById /';
  done;
fi

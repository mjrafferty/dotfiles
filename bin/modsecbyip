#! /bin/bash
readonly ARGS="$*"
readonly ARGA=("$@")

readonly CAT='/bin/cat'
readonly CUT='/bin/cut'
readonly GREP='/bin/grep'
readonly SED='/bin/sed'
readonly SORT='/bin/sort'

_usage() {
  "$CAT" <<- EOF

  Identifies all mod security rules triggered by the given IP address
  in the current error.log file. Must be run from the site's log directory.
  Output is the complete block to be copied into vhost.

  Usage:  modsecbyip < target ip >

EOF
}

main () {

  if [ -z "$ARGS" ] || [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local ip uris i logentries

  ip="${ARGS[0]}";

  # Grab necessary data from log
  logentries=$("$SED" -n 's/.*'"$ip"'.*\[uri \"\([^"]*\).*unique_id \"\([^"]*\).*/\2\t\1/p' error{,-ssl}.log);

  # Find unique uris
  uris=($(echo "$logentries" | "$CUT" -f2 | "$CUT" -d/ -f1-4 | "$SORT" -u ));

  echo "<IfModule mod_security2.c>";
  # Print LocationMatch block for each uri
  for ((i=0;i<${#uris[@]};i++)); do

		local uniqueid;

    uniqueid=($(echo "$logentries" | "$GREP" "${uris[$i]}"| "$CUT" -f1));

    echo "  <LocationMatch ${uris[$i]} >";
    echo "    # Ticket ID: $TICKET"
    for ((x=0;x<${#uniqueid[@]};x++)); do

      modsecrules "${uniqueid[$x]}";

    done \
      | "$SORT" -u \
      | "$SED" 's/^/    SecRuleRemoveById /';

    echo "  </LocationMatch>";

  done;
  echo "</IfModule>";
}

main;


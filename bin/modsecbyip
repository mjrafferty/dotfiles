#! /bin/bash
readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

main () {

  local ip uris uniqueid i

  if [ -z "$ARGS" ] || [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  ip="${ARGS[0]}";

  # Grab necessary data from log
  logentries=$(sed -n 's/.*'"$ip"'.*\[uri \"\([^"]*\).*unique_id \"\([^"]*\).*/\2\t\1/p' error.log);

  # Find unique uris
  uris=($(echo "$logentries" | cut -f2 | cut -d/ -f1-4 | sort -u ));


  echo "<IfModule mod_security2.c>";
  # Print LocationMatch block for each uri
  for ((i=0;i<${#uris[@]};i++)); do

    uniqueid=($(echo "$logentries" | grep "${uris[$i]}"| cut -f1));

    echo "  <LocationMatch ${uris[$i]} >";
    echo "    # Ticket ID: "
    for ((x=0;x<${#uniqueid[@]};x++)); do

      modsecrules "${uniqueid[$x]}";

    done \
      | sort -u \
      | sed 's/^/    SecRuleRemoveById /';

    echo "  </LocationMatch>";
    unset uniqueid;

  done;
  echo "</IfModule>";
}

main;


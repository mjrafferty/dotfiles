#! /bin/bash
readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF

  Identifies all mod security rules triggered by the given IP address
  in the current error.log file. Must be run from the site's log directory.
  Output is the complete block to be copied into vhost.

  Usage:  modsecbyip < target ip >

EOF
}

main () {

  if [ -z "$ARGS" ] || [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local ip uris uniqueid i logentries

  ip="${ARGS[0]}";

  # Grab necessary data from log
  logentries=$(sed -n 's/.*'"$ip"'.*\[uri \"\([^"]*\).*unique_id \"\([^"]*\).*/\2\t\1/p' error.log);

  # Find unique uris
  mapfile -t uris <(echo "$logentries" | cut -f2 | cut -d/ -f1-4 | sort -u );

  echo "<IfModule mod_security2.c>";
  # Print LocationMatch block for each uri
  for ((i=0;i<${#uris[@]};i++)); do

    mapfile -t uniqueid <(echo "$logentries" | grep "${uris[$i]}"| cut -f1);

    echo "  <LocationMatch ${uris[$i]} >";
    echo "    # Ticket ID: $TICKET"
    for ((x=0;x<${#uniqueid[@]};x++)); do

      modsecrules "${uniqueid[$x]}";

    done \
      | sort -u \
      | sed 's/^/    SecRuleRemoveById /';

    echo "  </LocationMatch>";
    unset uniqueid;

  done;
  echo "</IfModule>";
}

main;


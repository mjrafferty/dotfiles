#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly AWK='/bin/awk'
readonly COLUMN='/usr/bin/column'
readonly GREP='/bin/grep'
readonly ZLESS='/usr/bin/zless'

_awkStuff() {
  "$AWK" '
  BEGIN {
    print "Line\tFile_desc\tPort\tSocket/Address";
    print "----\t---------\t----\t--------------";
  }
  {
    gsub(/:/,"",$1);
    gsub(/(connect\(|,)/,"",$2);
    if (match($4,"sin_port")) {
      gsub(/(.*\(|\),)/,"",$4);
      gsub(/(.*\("|"\).*)/,"",$5);
      print $1,$2,$4,$5
    } else {
      gsub(/(.*="|"}.*)/,"",$4);
      print $1,$2,"0",$4
    }
  }
  END {

  }'
}

main () {

  "$ZLESS" "${ARGA[@]}" \
    | "$GREP" -no ' connect(.*'  \
    | _awkStuff \
    | "$COLUMN" -t

}

main;

#! /bin/bash

## manage .htaccess black-lists, white-lists, and bot-lists.
# parse through options/parameters
if [[ $1 =~ -p ]]; then sitepath=$2; shift; shift; else sitepath='.'; fi; opt=$1

	# run correct for-loop given list type
	case $opt in
		-b | --black)
			if ! grep -eq '.rder .llow,.eny' $sitepath/.htaccess &> /dev/null; then
				sudo -u $(getusr) echo -e "order allow,deny\nallow from all" >> $sitepath/.htaccess &&
					echo "$sitepath/.htaccess rules updated";
			fi
			shift; echo; for x in "$@"; do
			sed -i "s/\b\(.rder .llow,.eny\)/\1\ndeny from $x/" $sitepath/.htaccess &&
				echo "deny from $x ... added to $sitepath/.htaccess"
		done; echo
		;;

	-w | --white)
		if ! grep -eq '.rder .eny,.llow' $sitepath/.htaccess &> /dev/null; then
			sudo -u $(getusr) echo -e "order deny,allow\ndeny from all" >> $sitepath/.htaccess &&
				echo "$sitepath/.htaccess rules updated";
		fi
		shift; echo; for x in "$@"; do
		sed -i "s/\b\(.rder .eny,.llow\)/\1\nallow from $x/" $sitepath/.htaccess &&
			echo "allow from $x ... added to $sitepath/.htaccess"
	done; echo
	;;

-r | --robot)
	if grep -eq '.rder .llow,.eny' $sitepath/.htaccess &> /dev/null; then
		sed -i 's/\b\(.rder .llow,.eny\)/\1\ndeny from env=bad_bot/' $sitepath/.htaccess
	else sudo -u $(getusr) echo -e "\norder allow,deny\ndeny from env=bad_bot\nallow from all" >> $sitepath/.htaccess && echo "$sitepath/.htaccess rules updated."; fi

	shift; echo
	echo -e "\n# ----- block bad bots section -----\n" >> $sitepath/.htaccess
	for x in "$@"; do echo "browsermatchnocase $x bad_bot" | tee -a $sitepath/.htaccess; done
	echo -e "\n# ----- block bad bots section -----\n" >> $sitepath/.htaccess; echo
	;;

-h|--help|*)
	echo -e "\n  usage: htlist [options] <listtype> <ip1> <ip2> ...\n
	options:
	-p | --path .... path to .htaccess file
	-h | --help .... print this help and quit

	list types:
	-b | --black ... blacklist ips
	-w | --white ... whitelist ips
	-r | --robot ... block useragent\n";
	return 0;
	;;

esac


#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly LOGDIR="/var/log/send"
readonly DBFILE="${HOME}/maildb"

readonly CREATE_DB="CREATE TABLE SENDER(ID INT PRIMARY KEY AUTOINCREMENT,DATE TEXT NOT NULL,MESSAGE_ID INT NOT NULL,SENDER TEXT NOT NULL); \
  CREATE TABLE RECIPIENT(ID INT PRIMARY KEY AUTOINCREMENT,DATE TEXT NOT NULL,DELIVERY_ID INT NOT NULL,MESSAGE_ID INT NOT NULL,QUEUE_TYPE TEXT NOT NULL,RECIPIENT TEXT NOT NULL,RESPONSE_TYPE,RESPONSE_MSG);"

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done

  echo "$args";
}

_createDb () {
  echo "$CREATE_DB" \
    | sqlite3 $DBFILE;
}

_parseLogs () {
  awk "{

  type=\$3;

  if (type==\"info\")
    {
      printf \"INSERT INTO SENDER VALUES ('%s %s','%s','%s');\\n\",\$1,\$2,\$5,\$9;
    }
  else if (type==\"starting\")
    {
      printf \"INSERT INTO RECIPIENT VALUES ('%s %s','%s','%s',%s','%s',NULL);\\n\",\$1,\$2,\$5,\$7,\$9,\$10;
    }
  else if (type==\"delivery\")
    {
      printf \"UPDATE RECIPIENT SET response_type='%s' response_msg='%s' WHERE delivery_id='%s';\\n\",\$5,\$6,\$4;
    }

  }"
}

main () {

  while getopts "h" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
    esac

  done

  if [[ ! -e "$DBFILE" ]]; then

    _createDb;

    cat ${LOGDIR}/* \
      | tai64nlocal \
      | _parseLogs \
      sqlite3 "$DBFILE"

  fi

}

main;

#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly LOGDIR="/var/log/send"
readonly DBFILE="${HOME}/maildb"

readonly CREATE_DB="CREATE TABLE SENDER(ID INTEGER PRIMARY KEY AUTO_INCREMENT,DATE DATETIME NOT NULL,MESSAGE_ID INTEGER NOT NULL,SENDER VARCHAR(100) NOT NULL); \
  CREATE TABLE RECIPIENT(ID INTEGER PRIMARY KEY AUTO_INCREMENT,DATE DATETIME NOT NULL,DELIVERY_ID INTEGER NOT NULL,MESSAGE_ID INTEGER NOT NULL,QUEUE_TYPE VARCHAR(10) NOT NULL,RECIPIENT VARCHAR(100) NOT NULL,RESPONSE_TYPE VARCHAR(10),RESPONSE_MSG TEXT); \
  CREATE VIEW MAIL AS SELECT SENDER.DATE as \"Sent time\",SENDER.SENDER,RECIPIENT.DATE as \"Receive time\",RECIPIENT.QUEUE_TYPE,RECIPIENT.RECIPIENT,RECIPIENT.RESPONSE_TYPE,RECIPIENT.RESPONSE_MSG FROM SENDER INNER JOIN RECIPIENT ON SENDER.MESSAGE_ID = RECIPIENT.MESSAGE_ID;"

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done

  echo "$args";
}

_m () {
  mysql --defaults-extra-file=/root/.my.cnf --defaults-group-suffix=_root
}

_createDb () {

	_m <<- EOF
create database mattmaildb;
create user 'mattmaildb'@'localhost';
set old_passwords=0;
set password for 'mattmaildb'@'localhost' = password('SpawnedTypicalExaltNaked2284');
grant all on \`mattmaildb\`.* to 'mattmaildb'@'localhost';
EOF

  echo "$CREATE_DB" \
		| mysql -u'mattmaildb' -D'mattmaildb' -p'SpawnedTypicalExaltNaked2284'

}

_cleanUp () {
  _m <<- EOF
drop database mattmaildb;
drop user 'mattmaildb'@'localhost';
EOF
}

_parseLogs () {
  awk "{

  type=\$3;

  if (type==\"info\")
    {
      gsub(/:/,\"\",\$5);
      printf \"INSERT INTO SENDER VALUES (NULL,'%s %s','%s','%s');\\n\",\$1,\$2,\$5,\$9;
    }
  else if (type==\"starting\")
    {
      gsub(/:/,\"\",\$5);
      printf \"INSERT INTO RECIPIENT VALUES (NULL,'%s %s','%s','%s','%s','%s',NULL,NULL);\\n\",\$1,\$2,\$5,\$7,\$9,\$10;
    }
  else if (type==\"delivery\")
    {
      gsub(/:/,\"\",\$4);
      gsub(/:/,\"\",\$5);
      gsub(/'/,\"\",\$6);
      printf \"UPDATE RECIPIENT SET RESPONSE_TYPE='%s',RESPONSE_MSG='%s' WHERE DELIVERY_ID='%s' order by ID desc limit 1;\\n\",\$5,\$6,\$4;
    }

  }"
}

main () {

  while getopts "h" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
    esac

  done

    echo "Creating Database..."
    _createDb;

    echo "Inserting mail log data(This may take a few minutes)..."

    cat ${LOGDIR}/* \
      | tai64nlocal \
      | _parseLogs \
      | mysql -u'mattmaildb' -D'mattmaildb' -p'SpawnedTypicalExaltNaked2284'

		mysql -u'mattmaildb' -D'mattmaildb' -p'SpawnedTypicalExaltNaked2284'

    echo "Cleaning up...";

    _cleanUp;

}

main;

#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly LOGDIR="/var/log/send"
readonly DBFILE="${HOME}/maildb"

readonly CREATE_DB="CREATE TABLE SENDER(ID INTEGER PRIMARY KEY AUTOINCREMENT,DATE TEXT NOT NULL,MESSAGE_ID INTEGER NOT NULL,SENDER TEXT NOT NULL); \
  CREATE TABLE RECIPIENT(ID INTEGER PRIMARY KEY AUTOINCREMENT,DATE TEXT NOT NULL,DELIVERY_ID INTEGER NOT NULL,MESSAGE_ID INTEGER NOT NULL,QUEUE_TYPE TEXT NOT NULL,RECIPIENT TEXT NOT NULL,RESPONSE_TYPE,RESPONSE_MSG);"

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done

  echo "$args";
}

_createDb () {

  sqlite3 "$DBFILE" "$CREATE_DB";

}

_parseLogs () {
  awk "{

  type=\$3;

  if (type==\"info\")
    {
      gsub(/:/,\"\",\$5);
      printf \"INSERT INTO SENDER VALUES (NULL,'%s %s','%s','%s');\\n\",\$1,\$2,\$5,\$9;
    }
  else if (type==\"starting\")
    {
      gsub(/:/,\"\",\$5);
      printf \"INSERT INTO RECIPIENT VALUES (NULL,'%s %s','%s','%s','%s','%s',NULL,NULL);\\n\",\$1,\$2,\$5,\$7,\$9,\$10;
    }
  else if (type==\"delivery\")
    {
      gsub(/:/,\"\",\$5);
      gsub(/'/,\"\",\$6);
      printf \"UPDATE RECIPIENT SET RESPONSE_TYPE='%s',RESPONSE_MSG='%s' WHERE ID=(SELECT ID FROM RECIPIENT where DELIVERY_ID='%s' order by ID desc limit 1);\\n\",\$5,\$6,\$4;
    }

  }"
}

main () {

  while getopts "h" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
    esac

  done

  if [[ ! -e "$DBFILE" ]]; then

    _createDb;

    cat ${LOGDIR}/* \
      | tai64nlocal \
      | _parseLogs \
      sqlite3 "$DBFILE"

  fi

}

main;

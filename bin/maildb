#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly LOGDIR="/var/log/send"
readonly DBFILE="${HOME}/maildb"

readonly CREATE_DB="CREATE TABLE sender(row_id INTEGER PRIMARY KEY,date DATETIME NOT NULL,message_id INTEGER NOT NULL,sender VARCHAR(100) NOT NULL) ENGINE=InnoDB; \
  CREATE TABLE recipient(row_id INTEGER PRIMARY KEY,date DATETIME NOT NULL,delivery_id INTEGER NOT NULL,message_id INTEGER NOT NULL,queue_type VARCHAR(10) NOT NULL,recipient VARCHAR(100) NOT NULL) ENGINE=InnoDB; \
  CREATE TABLE delivery(row_id INTEGER PRIMARY KEY AUTO_INCREMENT,date DATETIME NOT NULL,delivery_id INTEGER NOT NULL,response_type VARCHAR(10),response_msg TEXT) ENGINE=InnoDB; \
  CREATE VIEW mail AS select sender.date as created_date, recipient.date as sent_date, delivery.date as delivery_date, sender, recipient, queue_type, response_type, response_msg from sender inner join recipient on recipient.message_id=sender.row_id inner join delivery on recipient.row_id=delivery.delivery_id;"

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done

  echo "$args";
}

_m () {
  mysql --defaults-extra-file=/root/.my.cnf --defaults-group-suffix=_root 2> /dev/null
}

_createDb () {

  echo "Creating Database..."

  _m <<- EOF
create database mattmaildb;
create user 'mattmaildb'@'localhost';
set old_passwords=0;
set password for 'mattmaildb'@'localhost' = password('SpawnedTypicalExaltNaked2284');
grant all on \`mattmaildb\`.* to 'mattmaildb'@'localhost';
EOF

echo "$CREATE_DB" \
  | mysql -u'mattmaildb' -D'mattmaildb' -p'SpawnedTypicalExaltNaked2284'

}

_cleanUp () {

  echo "Cleaning up...";

  _m <<- EOF
drop database mattmaildb;
drop user 'mattmaildb'@'localhost';
EOF
}

_parseLogs () {
  awk "
  BEGIN {
    sender_file=\"sender_file\";
    recipient_file=\"recipient_file\";
    delivery_file=\"delivery_file\";

    sender_row_id=0;
    recipient_row_id=0;

    printf \"INSERT INTO sender VALUES \" >sender_file;
    printf \"INSERT INTO recipient VALUES \" >recipient_file;
    printf \"INSERT INTO delivery VALUES \" >delivery_file;
  }

  {
    type=\$3;

    if (type==\"info\")
      {
        gsub(/:/,\"\",\$5);

        sender_row_id++;
        message_ids[\$5]=sender_row_id;

        printf \"('%s','%s %s','%s','%s'),\",sender_row_id,\$1,\$2,\$5,\$9 >sender_file;
      }
    else if (type==\"starting\")
      {
        gsub(/:/,\"\",\$5);

        recipient_row_id++;
        delivery_ids[\$5]=recipient_row_id;

        if(message_ids[\$7] == \"\"){
          msg_fkey=\"NULL\";
        } else
        {
          msg_fkey=message_ids[\$7];
        }

        printf \"('%s','%s %s','%s','%s','%s','%s'),\",recipient_row_id,\$1,\$2,\$5,msg_fkey,\$9,\$10 >recipient_file;
      }
    else if (type==\"delivery\")
      {
        gsub(/:/,\"\",\$4);
        gsub(/:/,\"\",\$5);
        gsub(/'/,\"\",\$6);

        if(delivery_ids[\$4] == \"\"){
          del_fkey=\"NULL\";
        } else
        {
          del_fkey=delivery_ids[\$4];
        }

        printf \"(NULL,'%s %s','%s','%s','%s'),\",\$1,\$2,del_fkey,\$5,\$6 >delivery_file;
      }

    }
  END {
    sender_row_id++;
    recipient_row_id++;

    printf \"('%s','0000-00-00 00:00:00','NULLish','NULLish');\",sender_row_id >sender_file;
    printf \"('%s','0000-00-00 00:00:00','NULLish','NULLish','NULLish','NULLish');\",recipient_row_id >recipient_file;
    printf \"(NULL,'0000-00-00 00:00:00','NULLish','NULLish','NULLish');\" >delivery_file;
  }"
}

main () {

  while getopts "h" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
    esac

  done

  trap "_cleanUp" EXIT;

  _createDb;

  echo "Parsing mail logs..."

  cat ${LOGDIR}/* \
    | tai64nlocal \
    | _parseLogs

  echo "Inserting mail log data(This may take a few minutes)..."

  for x in sender_file recipient_file delivery_file; do
    cat $x;
  done \
    | mysql -u'mattmaildb' -D'mattmaildb' -p'SpawnedTypicalExaltNaked2284'

  mysql -u'mattmaildb' -D'mattmaildb' -p'SpawnedTypicalExaltNaked2284'

}

main;

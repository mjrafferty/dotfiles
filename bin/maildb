#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly DBNAME=""

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done

  echo "$args";
}

_parseLogs () {
  awk '{

  type=$3;
  timestamp=$1" "$2

  if (type=="info")
    {
      printf "INSERT INTO SENDER VALUES (%s,%s,%s);\n",timestamp,$5,$9;
    } else if (type=="starting")
    {
      printf "INSERT INTO RECIPIENT VALUES (%s,%s,%s,%s,NULL);\n",timestamp,$5,$9,$10;
    } else if (type=="delivery")
    {
      msg=$4;
      $1=""; $2=""; $3="" $4="";
      printf "UPDATE RECIPIENT SET RESPONSE=%s where message=%s;\n",$0,msg;
    }

  }'
}

main () {

  while getopts "hxt:c:" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
    esac

  done

  cat /var/log/send/* \
    | tai64nlocal \
    | _parseLogs;

}

main;

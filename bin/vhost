#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

alias cat='/bin/cat'
alias column='/usr/bin/column'
alias grep='/bin/grep'
alias sed='/bin/sed'
alias tr='/usr/bin/tr'

_usage() {
  cat <<- EOF

When run with no arguments, it will attempt to open the vhost relevant
to your current working directory. If run from a user's home directory,
it will provide a list of their vhosts. It may also be run with a substring
of a domain as an argument to find a vhost.

EOF
}

main () {

  local vhost domain;

  if [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  if [  -n "${ARGA[0]}" ]; then

    domain=$(echo "${ARGA[0]}" | sed -r -e 's_https?://__' -e 's_/$__' | tr "[:upper:]" "[:lower:]");

  else

    domain="$(pwd | sed -e 's_\(.*home/[^/]*/[^/]*\)/html.*_\1_' -e 's_\(.*home/[^/]*/var/[^/]*\)/.*_\1_')";

  fi

  mapfile -t vhost <(grep -l "$domain" /etc/httpd/conf.d/vhost*);

  if [ -z "${vhost[0]}" ]; then

    echo "No vhost found";
    exit;

  elif [  -n "${vhost[1]}" ]; then

    echo "Domain ambiguous. Select vhost:";

    for (( i=0; i<${#vhost[@]}; i++ )); do

      echo "$i  ${vhost[$i]}";

    done \
      | column -t;

    echo;

    read -rp "Choose vhost number:" selection;

    vhost[0]=${vhost[$selection]};

  fi;

  "$EDITOR" "${vhost[0]}";

  echo "${vhost[0]}";

}

main;

#! /bin/bash


## show backupserver and disk usage for current home directory
checkquota;
new_ipaddr=$(awk -f/ '/server.allow/ {print $nf}' /usr/sbin/r1soft/log/cdp.log | tail -1 | tr -d \' | sed 's/10\.17\./178\.17\./g; s/10\.1\./103\.1\./g; s/10\.240\./192\.240\./g');
all_ipaddr=$(awk -f/ '/server.allow/ {print $nf}' /usr/sbin/r1soft/log/cdp.log | sort | uniq | tr -d \' | sed 's/10\.17\./178\.17\./g; s/10\.1\./103\.1\./g; s/10\.240\./192\.240\./g');
if [[ $new_ipaddr =~ ^172\. ]]; then internal=$(curl -s http://mdsc.info/r1bs-internal); fi

_printbackupsvr(){
	if [[ $1 =~ ^172\. ]]; then
		for x in $internal; do echo -n $x | awk -f_ "/$1/"'{printf "r1soft ip..: https://"$3":8001\n" "r1soft rdns: https://"$2":8001\n"}'; done
	else
		ip=$1; rdns=$(dig +short -x $1 2> /dev/null);
		echo "r1soft ip..: https://${ip}:8001";
		if [[ -n $rdns ]]; then echo "r1soft rdns: https://$(echo $rdns | sed 's/\.$//'):8001"; fi;
		fi
		echo
	}

	firstseen=$(grep $(echo $new_ipaddr | cut -d. -f2-) /usr/sbin/r1soft/log/cdp.log | head -1 | awk '{print $1}');
	echo "----- current r1soft server ----- $firstseen] $(dash 32)"; _printbackupsvr $new_ipaddr

	for ipaddr in $all_ipaddr; do
		if [[ $ipaddr != $new_ipaddr ]]; then
			lastseen=$(grep $(echo $ipaddr | cut -d. -f2-) /usr/sbin/r1soft/log/cdp.log | tail -1 | awk '{print $1}');
			echo "----- previous r1soft server ----- $lastseen] $(dash 31)"; _printbackupsvr $ipaddr
		fi;
	done


#! /bin/bash

## Show backupserver and disk usage for current home directory

_printbackupsvr () {

  local ip internal rdns;

  if [[ $1 =~ ^172\. ]]; then

    for x in $internal; do

      internal=$(curl -s http://mdsc.info/r1bs-internal);
      echo -n "$x" \
        | awk -F_ "/$1/"'{printf "R1Soft IP..: https://"$3":8001\n" "R1Soft rDNS: https://"$2":8001\n"}';

    done

  else

    ip=$1;
    rdns=$(dig +short -x "$1" 2> /dev/null);

    echo "R1Soft IP..: https://${ip}:8001";

    if [[ -n $rdns ]]; then

      echo "R1Soft rDNS: https://${rdns/net./net}:8001";

    fi;
  fi
  echo;
}

main () {

  local new_ipaddr all_ipaddr firstseen lastseen ipaddr;

  new_ipaddr=$(awk -F/ '/server.allow/ {print $NF}' /usr/sbin/r1soft/log/cdp.log \
    | tail -1 \
    | tr -d \' \
    | sed 's/10\.17\./178\.17\./g; s/10\.1\./103\.1\./g; s/10\.240\./192\.240\./g');

  all_ipaddr=$(awk -F/ '/server.allow/ {print $NF}' /usr/sbin/r1soft/log/cdp.log \
    | sort \
    | uniq \
    | tr -d \' \
    | sed 's/10\.17\./178\.17\./g; s/10\.1\./103\.1\./g; s/10\.240\./192\.240\./g');

  firstseen=$(grep "$(echo "$new_ipaddr" \
    | cut -d. -f2-)" /usr/sbin/r1soft/log/cdp.log \
    | head -1 \
    | awk '{print $1}');

  echo "----- Current R1Soft Server ----- $firstseen] $(dashes 32)";

  _printbackupsvr "$new_ipaddr"

  for ipaddr in $all_ipaddr; do

    if [[ $ipaddr != "$new_ipaddr" ]]; then

      lastseen=$(grep "$(echo "$ipaddr" | cut -d. -f2-)" /usr/sbin/r1soft/log/cdp.log | tail -1 | awk '{print $1}');

      echo "----- Previous R1Soft Server ----- $lastseen] $(dashes 31)"; _printbackupsvr "$ipaddr"

    fi;

  done
}

main;

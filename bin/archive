#! /bin/bash

## Archive a particular target, adding time and date information
main () {

  local file size sizem user;

  echo;

  if [[ -z "$*" ]]; then

    echo -e " usersage: archive <target>\n";
    return 0;

  fi

  file=$(getusr).$(hostname | cut -d. -f1)--"${1/\//-}"-$(date +%Y.%m.%d-%H.%M).tgz;
  size=$(du -sb "$1" | cut -f1);
  sizem=$(echo "scale=3;$size/1024/1024" | bc);

  echo "Compressing ${sizem}M ... please be patient."

  if [[ -f /usr/bin/pv && -f /usr/bin/pigz ]]; then

    tar -cf - "$1" \
      | pv -s "${size}" \
      | pigz -c > "$file";

  elif [[ -f /usr/bin/pv ]]; then

    tar -cf - "$1" \
      | pv -s "${size}" \
      | gzip -c > "$file";

  else

    echo "Sorry, no idea how long this will take ...";
    tar -zcf  "$file" "$1";

  fi \
    && echo -e "\nArchive created successfully!\n\n$PWD/\n$file\n";

  if [[ -f $file ]]; then

    read -rp "Chown file to [r]oot or [u]ser? [r/u]: " yn;

    if [[ $yn = "r" ]]; then

      user='root';

    else

      user=$(getusr);

    fi;

    chown "$user". "$file" && echo -e "Archive owned to $user\n";

  fi
}

main "$@";

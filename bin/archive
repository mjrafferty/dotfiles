#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF
  Archive a particular target, adding time and date information

  archive <target>

EOF
}

_compress () {

  local target size file

  target="$1";
  file="$2";
  size="$3";

  if [[ -f /usr/bin/pv && -f /usr/bin/pigz ]]; then

    tar -cf - "$target" \
      | pv -s "${size}" \
      | pigz -c > "$file";

  elif [[ -f /usr/bin/pv ]]; then

    tar -cf - "$target" \
      | pv -s "${size}" \
      | gzip -c > "$file";

  else

    echo "Sorry, no idea how long this will take ...";
    tar -zcf  "$file" "$target";

  fi \
    && echo -e "\nArchive created successfully!\n\n$PWD/\n$file\n";
}

_chown () {

  local file yn user
  file="$1";

  if [[ -f $file ]]; then

    read -rp "Chown file to [r]oot or [u]ser? [r/u]: " yn;

    if [[ $yn = "r" ]]; then

      user='root';

    else

      user=$(getusr);

    fi;

    chown "$user". "$file" \
      && echo -e "Archive owned to $user\n";

  fi

}

main () {

  local target file size sizem;

  target="${ARGA[0]}"
  file=$(getusr).$(hostname | cut -d. -f1)--"${target/\//-}"-$(date +%Y.%m.%d-%H.%M).tgz;
  size=$(du -sb "$target" | cut -f1);
  sizem=$(echo "scale=3;$size/1024/1024" | bc);

  echo "Compressing ${sizem}M ... please be patient."

  _compress "$target" "$file" "$size";

  _chown "$file";

}

main;

#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly CAT='/bin/cat'
readonly CHOWN='/bin/chown'
readonly CUT='/bin/cut'
readonly DATE='/bin/date'
readonly DU='/usr/bin/du'
readonly GZIP='/bin/gzip';
readonly PIGZ='/usr/bin/pigz';
readonly TAR='/bin/tar'

_usage() {
  "$CAT" <<- EOF

  Archive a particular target, adding time and date information

  archive <target>

EOF
}

_compress () {

  local target size file

  target="$1";
  file="$2";
  size="$3";

  if [[ -f /usr/bin/pv && -f /usr/bin/pigz ]]; then

    "$TAR" -cf - "$target" \
      | pv -s "${size}" \
      | "$PIGZ" -c > "$file";

  elif [[ -f /usr/bin/pv ]]; then

    "$TAR" -cf - "$target" \
      | pv -s "${size}" \
      | "$GZIP" -c > "$file";

  else

    echo "Sorry, no idea how long this will take ...";
    "$TAR" -zcf  "$file" "$target";

  fi \
    && echo -e "\nArchive created successfully!\n\n$PWD/$file\n";
}

_chown () {

  local file yn user
  file="$1";

  read -rp "Chown file to [r]oot or [u]ser? [r/u]: " yn;

  if [[ $yn = "r" ]]; then

    user='root';

  else

    user=$(getusr);

  fi;

  "$CHOWN" "$user". "$file" \
    && echo -e "Archive owned to $user\n";

}

main () {

  local target file size sizem;

  if [[ -z "$ARGS" || "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  target="${ARGA[0]}"
  file="${target/\//-}-$("$DATE" +%Y.%m.%d-%H.%M).tgz";
  size=$("$DU" -sb "$target" | "$CUT" -f1);
  sizem=$(echo "scale=3;$size/1024/1024" | bc);

  printf "Compressing %sM ... please be patient.\n" "$sizem"

  _compress "$target" "$file" "$size";

  [[ -f $file ]] || return 1;

  _chown "$file";

}

main;

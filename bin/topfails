#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

if ! readlink /proc/$$/fd/0 | grep -q "^pipe:"; then
  LOGS=($(find /var/log/send -type f));
fi

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac

  done

  echo "$args";
}

main () {

  while getopts "hxt:c:" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
    esac

  done

	for x in $(grep -Po "delivery \K\d*(?=: failure.*)" /var/log/send/*); do
		for y in $(grep -Po "starting delivery ${x}: msg \K\d*" /var/log/send/*); do
			grep -Po "info msg ${y}: bytes \d* from <\K[^>]*" /var/log/send/*;
		done;
	done \
		| sort \
		| uniq -c \
		| sort -hr \
		| head
}

main;

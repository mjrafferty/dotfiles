#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly IP="192.240.191.2"
readonly TMP_EXT=".nexcess.bak"

_usage() {
  cat <<- EOF
  strace a php-fpm process when
EOF
}

_addCode () {

  mv "$1"{,"$TMP_EXT"} || return 1;

  cat << EOF >> "$1"
<?php
  ### Nexcess diagnostic edit - please remove when not in use
  if(\$_SERVER["REMOTE_ADDR"] == "$IP" || \$_SERVER["HTTP_X_FORWARDED_FOR"] == "$IP"){
    \$f = fopen('/tmp/flag','w');
    sleep(2);
    fclose(\$f);
  }
  ### End Nexcess diagnostic edit - please remove when not in use
?>
EOF

  cat "$1""$TMP_EXT" >> "$1";

}

_strace () {

  local pid str_pid output

  output="$HOME/strace-$(date "+%F-%T")";

  rm /tmp/flag 2> /dev/null;

  set -m;
  while [ ! -f /tmp/flag ]; do
    printf "\rWaiting for process. Press enter to stop.";
    if read -rt0.1; then
      return;
    fi
  done

  pid="$(lsof -tf -- /tmp/flag)";
  strace -fTrvs200000 -o "$output" -p"$pid" &

  str_pid="$!"

  sleep 0.1;
  while(true); do
    if tail "$output" | grep -q "accept(0"; then
      kill "$str_pid";
      break;
    fi
  done
}

main () {

  if [ -z "$ARGS" ] || [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local target="${ARGA[0]}";

  _addCode "$target" || return 1;

  _strace;

  mv -f "$target"{"$TMP_EXT",}

}

main;

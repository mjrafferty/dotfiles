#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

readonly TMP_EXT=".nexcess.bak"

_usage() {
  cat <<- EOF

  Perform a strace of a php-fpm process when requesting a page.
  Outputs strace to home directory. Target is usually site's
  index.php, though not always.

  Usage:

  capstrace <target>

EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    local args

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      "--location"|"-l")
        args="${args}-l "
        ;;
      "--ip-address"|"-i")
        args="${args}-i "
        ;;
      "--uri"|"-u")
        args="${args}-u "
        ;;
      *)
        args="${args}${x} ";
        ;;
    esac

  done


  echo "$args";
}

_addCode () {

  local file address uri uristring;

  file="$1";
  address="$2";
  uri="$3";

  mv "$file"{,"$TMP_EXT"} || return 1;

  if [[ "$uri" == "/" ]]; then
    uristring="";
  else
    uristring=" and (strlen(strstr(\$_SERVER[\"REQUEST_URI\"],\"$uri\"))>0)";
  fi

  cat << EOF >> "$file"
<<?php
  if((\$_SERVER["REMOTE_ADDR"] == "$address" || \$_SERVER["HTTP_X_FORWARDED_FOR"] == "$address")$uristring){
    \$f = fopen('/tmp/flag','w');
    sleep(2);
    fclose(\$f);
  }
?>
EOF

  cat "$file""$TMP_EXT" >> "$file";
  chown "$(getusr)". "$file";

}

_strace () {

  local pid str_pid output

  output="$HOME/strace-$(date "+%F-%T")";

  rm /tmp/flag 2> /dev/null;

  trap 'return' INT;

  set -m;
  while [ ! -f /tmp/flag ]; do
    printf "\rWaiting for process. Press enter to stop.";
    if read -rt0.1; then
      return;
    fi
  done

  pid="$(lsof -tf -- /tmp/flag)";

  strace -fTrvs200000 -o "$output" -p"$pid" &

  str_pid="$!"

  trap 'break' INT;
  sleep 0.1;
  while(true); do
    if tail "$output" | grep -q "accept(0"; then
      kill "$str_pid";
      break;
    fi
  done

  kill "$str_pid" 2> /dev/null;
}

main () {

  local file address uri;

  while getopts "hf:i:u:" OPTION "$(_cmdline)"; do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
      f)
        file="$OPTARG";
        ;;
      i)
        address="$OPTARG";
        ;;
      u)
        uri="$OPTARG";
        ;;
    esac

  done

  if [[ -z "$file" ]]; then
    file="${ARGA[0]}";
  fi

  if [[ -z "$address" ]]; then
    address="192.240.191.2";
  fi

  if [[ -z "$uri" ]]; then
    uri="/";
  fi

  _addCode "$file" "$address" "$uri" || return 1;

  _strace;

  mv -f "$file"{"$TMP_EXT",}

}

main;

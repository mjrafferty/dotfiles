#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
	cat <<- EOF
	This is the usage
EOF
}

_awkStuff () {
	awk '
	{
		gsub(/<|>/,"",$(NF));

		if ( match($3,/^(access|lstat|open|munmap|mmap|stat|brk|chdir|socket|setitimer)\(/) )
			{
				syscall = gensub(/(\().*/,"\\1","G",$3);
			}
		else if ( match($3,/^poll\(/) )
			{
				syscall = gensub(/(\(.{7}).*/,"\\1","G",$3);
			}
		else {
			syscall = gensub(/(\(..).*/,"\\1","G",$3);
		}

		time[syscall]+=$(NF);
		numcalls[syscall]++;
	}

	END {
		for (x in time)
			{
				printf "%s\t%10.4f\t%s\n",x,time[x],numcalls[x];
			}
	}'
}

main () {

	if [[ -z "$ARGS" || "$ARGS" =~ --help$|-h$ ]]; then
		_usage;
		return 0;
	fi

	echo;
	(printf "syscall\ttime\tquantity\n%s\t%s\t%s\n" "----------" "----------" "----------"
	zless ${ARGA[*]} \
		| _awkStuff  \
		| sort -k2nr) \
		| head -n30 \
		| column -t

	echo;

}

main;

#!/usr/bin/env php

<?php

$domain="";
$user="";
$pass="";
$secure="";
$mode="";

$client="";
$session="";
$result="";


function _parseCmdLine () {

  global $domain;
  global $user;
  global $pass;
  global $secure;
  global $mode;

  $shortopts  = "";
  $shortopts .= "d:";
  $shortopts .= "u:";
  $shortopts .= "p:";
  $shortopts .= "m:";
  $shortopts .= "s";

  $longopts  = array(
    "domain:",
    "user:",
    "pass:",
    "mode:",
    "secure",
  );

  $cmdline = getopt($shortopts,$longopts);

  foreach ($cmdline as $opt => $value) {

    switch ($opt) {

    case d:
    case domain:
      $domain=$value;
      break;
    case u:
    case user:
      $user=$value;
      break;
    case p:
    case pass:
      $pass=$value;
      break;
    case s:
    case secure:
      $secure="s";
      break;
    case m:
    case mode:
      $mode=$value;
      break;
    default:
      break;

    }

  }

}

function _soapv1 () {

  global $client;
  global $session;
  global $result;
  global $domain;
  global $secure;
  global $user;
  global $pass;
  global $result;

  $client = new SoapClient('http' . $secure . '://'.$domain.'/api/soap/?wsdl', array('trace' => 1, 'connection_timeout' => 120));
  $session = $client->login($user, $pass);

  echo $client->__getLastRequest();
  echo $client->__getLastResponse();

  $result = $client->call($session, 'product.list');

}

function _soapv2 () {

  global $client;
  global $session;
  global $result;
  global $domain;
  global $secure;
  global $user;
  global $pass;
  global $result;

  $client = new SoapClient('http' . $secure . '://'.$domain.'/api/v2_soap?wsdl=1', array('trace' => 1, 'connection_timeout' => 120));
  $session = $client->login($user, $pass);

  echo $client->__getLastRequest();
  echo $client->__getLastResponse();

  $result = $client->catalogProductList($session);

}

function _soapv2wsi () {

  global $client;
  global $session;
  global $result;
  global $domain;
  global $secure;
  global $user;
  global $pass;
  global $result;

  $client = new SoapClient('http' . $secure . '://'.$domain.'/api/v2_soap/?wsdl', array('trace' => 1, 'connection_timeout' => 120));
  $session = $client->login((object)array('username' => $user, 'apiKey' => $pass));

  echo $client->__getLastRequest();
  echo $client->__getLastResponse();

  $result = $client->catalogProductList((object)array('session' => $session->result, 'filters' => null));

}

function _doSoap () {

  global $mode;
  global $result;
  global $session;
  global $client;

  try {

    switch ($mode) {

    case v1:
      _soapv1();
      break;

    case v2:
      _soapv1();
      break;

    case wsi:
      _soapv2wsi();
      break;

    }

    var_dump($result->result);

  }

  catch (Exception $e) {

    var_dump($e);

  }

  $client->endSession($session);

}

function _start () {

  _parseCmdLine();

  _doSoap();

}

_start();

?>

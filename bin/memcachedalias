#! /bin/bash

## Create user functions for memcached socket configured in local.xml
if [[ -z $1 || $1 == '-h' || $1 == '--help' ]]; then
  echo -e "\n Usage: memcachealias [sitepath] [name]\n"
elif [[ -f $1/app/etc/local.xml ]]; then
  if [[ -n $2 ]]; then
    NAME="_$2";
  else
    NAME='_memcached';
  fi
  U=$(getusr);
  CACHE_SOCKET=$(grep -Eo '\/var.*_cache\.sock' $1/app/etc/local.xml | head -1)
  SESSIONS_SOCKET=$(grep -Eo '\/var.*_sessions\.sock' $1/app/etc/local.xml | head -1)

  echo;
  for x in flush_all stats; do
    if [[ -n $SESSIONS_SOCKET ]]; then
      echo "Adding ${x}${NAME}_cache to /home/$U/.bashrc ... ";
      sudo -u $U echo "${x}${NAME}_cache(){ echo $x \$@ | nc -U $CACHE_SOCKET; }" >> /home/$U/.bashrc;
      echo "Adding ${x}${NAME}_sessions to /home/$U/.bashrc ... ";
      sudo -u $U echo "${x}${NAME}_sessions(){ echo $x \$@ | nc -U $SESSIONS_SOCKET; }" >> /home/$U/.bashrc;
    else
      echo "Adding ${x}${NAME}_cache to /home/$U/.bashrc ... ";
      sudo -u $U echo "${x}${NAME}_cache(){ echo $x \$@ | nc -U $CACHE_SOCKET; }" >> /home/$U/.bashrc;
    fi;
  done;
  echo;

  echo "Adding bash completion for stats function"
  sudo -u $U echo -e "\ncomplete -W 'items slabs detail sizes reset' stats${NAME}_cache" >> /home/$U/.bashrc
  sudo -u $U echo -e "\ncomplete -W 'items slabs detail sizes reset' stats${NAME}_sessions" >> /home/$U/.bashrc
  echo "Adding $U to the (nc) group";
  usermod -a -G nc $U;
  echo;
else
  echo "\n Could not find local.xml file in $1\n";
fi;

#! /bin/bash

## Find basic Drupal information and display it in the nexkit-style

readonly ARGS="$*"
readonly ARGA=("$@")

readonly AWK='/bin/awk'
readonly CAT='/bin/cat'
readonly CUT='/bin/cut'
readonly FIND='/bin/find'
readonly GREP='/bin/grep'
readonly MYSQL='/usr/bin/mysql'
readonly SED='/bin/sed'
readonly STAT='/usr/bin/stat'
readonly TAIL='/usr/bin/tail'

_usage() {
  "$CAT" <<- EOF
  This is the usage
EOF
}

main () {

  if [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local sitepath config verfile version installdate dbname dbuser dbpass dbhost dbdriv prefix;
  local base_path base_url sitename posts;

  if [[ -n ${ARGA[0]} ]]; then
    sitepath="${ARGA[0]}";
  else
    sitepath='.';
  fi

  config="${sitepath}/sites/default/settings.php"

  [[ -f ${config} ]] || (echo -e "\nCould not "$FIND" Drupal install at ${sitepath}\n"; return 1);

  # Version Information
  if "$GREP" -q "define('VERSION'" ${sitepath}/modules/system/system.module; then
    verfile="${sitepath}/modules/system/system.module"
  elif "$GREP" -q "define('VERSION'" ${sitepath}/includes/bootstrap.inc; then
    verfile="${sitepath}/includes/bootstrap.inc"
  fi;

  version=$("$GREP" "define('VERSION'" $verfile | "$CUT" -d\' -f4)
  installdate=$("$STAT" $verfile | "$AWK" '/Change/ {print $2,$3}' | "$CUT" -d. -f1)

  # Database Config (7.x)
  # Database, Username, Password, Host, Driver, Prefix
  if [[ $version =~ ^7 || $version =~ ^8 ]]; then

    dbname=$("$AWK" '($1 ~ /database/ && $3 !~ /array/) {print $3}' $config | "$CUT" -d\' -f2)
    dbuser=$("$AWK" '($1 ~ /username/) {print $3}' $config | "$CUT" -d\' -f2)
    dbpass=$("$AWK" '($1 ~ /password/) {print $3}' $config | "$CUT" -d\' -f2)
    dbhost=$("$AWK" '($1 ~ /host/) {print $3}' $config | "$CUT" -d\' -f2)
    dbdriv=$("$AWK" '($1 ~ /driver/) {print $3}' $config | "$CUT" -d\' -f2)
    prefix=$("$AWK" '($1 ~ /prefix/) {print $3}' $config | "$CUT" -d\' -f2)

    # Database Config (6.x)
    # mysql://username:password@localhost/database
  elif [[ $version =~ ^6 || $version =~ ^5 ]]; then

    dbase=$("$AWK" '($1 ~ /db_url/) {print $3}' $config | "$CUT" -d\' -f2)
    dbname=$(echo "$dbase" | "$CUT" -d@ -f2 | "$CUT" -d/ -f2)
    dbuser=$(echo "$dbase" | "$CUT" -d: -f2 | "$CUT" -d/ -f3)
    dbpass=$(echo "$dbase" | "$CUT" -d: -f3 | "$CUT" -d@ -f1)
    dbhost=$(echo "$dbase" | "$CUT" -d@ -f2 | "$CUT" -d/ -f1)
    dbdriv=$(echo "$dbase" | "$CUT" -d: -f1)
    prefix=$("$AWK" '($1 ~ /db_prefix/) {print $3}' $config | "$CUT" -d\' -f2)

  fi

  database="${dbdriv}://${dbuser}:${dbpass}@${dbhost}/${dbname}$(if [[ -n ${prefix} ]]; then echo ."${prefix}"*; fi)"

  base_path=$(cd $sitepath || return; pwd -P;)
  base_url=$(cd $sitepath || return; pwd -P | "$SED" 's:/chroot::g;s:/html::g' | "$CUT" -d/ -f4-)
  sitename=$("$MYSQL" -u "$dbuser" -p"$dbpass" "$dbname" -h "$dbhost" -e "select name,value from ${prefix}variable where name=\"site_name\";" | "$TAIL" -1 | "$CUT" -d\" -f2)
  posts=$("$MYSQL" -u "$dbuser" -p"$dbpass" "$dbname" -h "$dbhost" -e "select count(*) from ${prefix}node;" | "$TAIL" -1)

  echo;
  printf "%-18s: %s\n" "Base Path" "${base_path}"
  printf "%-18s: %s\n" "Site Title" "${sitename}"
  printf "%-18s: %s\n" "Install Date" "${installdate}"
  printf "%-18s: %s\n" "Version" "${version}"
  printf "%-18s: %s\n" "Front End URL" "http://${base_url}"
  printf "%-18s: %s\n" "Back End URL" "http://${base_url}/admin"
  printf "%-18s: %s\n" "Post Count" "${posts}"
  printf "%-18s: %s\n" "DB Connection" "${database}"
  echo;

}

main;

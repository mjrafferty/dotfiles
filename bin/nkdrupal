#! /bin/bash

## Find basic Drupal information and display it in the nexkit-style

if [[ -n $1 ]]; then
  sitepath="$1";
else
  sitepath='.';
fi

config="${sitepath}/sites/default/settings.php"

if [[ -f ${config} ]]; then

  # Version Information
  if grep -q "define('VERSION'" ${sitepath}/modules/system/system.module; then
    verfile="${sitepath}/modules/system/system.module"
  elif grep -q "define('VERSION'" ${sitepath}/includes/bootstrap.inc; then
    verfile="${sitepath}/includes/bootstrap.inc"
  fi;

  version=$(grep "define('VERSION'" $verfile | cut -d\' -f4)
  installdate=$(stat $verfile | awk '/Change/ {print $2,$3}' | cut -d. -f1)

  # Database Config (7.x)
  # Database, Username, Password, Host, Driver, Prefix
  if [[ $version =~ ^7 || $version =~ ^8 ]]; then

    dbname=$(awk '($1 ~ /database/ && $3 !~ /array/) {print $3}' $config | cut -d\' -f2)
    dbuser=$(awk '($1 ~ /username/) {print $3}' $config | cut -d\' -f2)
    dbpass=$(awk '($1 ~ /password/) {print $3}' $config | cut -d\' -f2)
    dbhost=$(awk '($1 ~ /host/) {print $3}' $config | cut -d\' -f2)
    dbdriv=$(awk '($1 ~ /driver/) {print $3}' $config | cut -d\' -f2)
    prefix=$(awk '($1 ~ /prefix/) {print $3}' $config | cut -d\' -f2)

    # Database Config (6.x)
    # mysql://username:password@localhost/database
  elif [[ $version =~ ^6 || $version =~ ^5 ]]; then

    dbase=$(awk '($1 ~ /db_url/) {print $3}' $config | cut -d\' -f2)
    dbname=$(echo "$dbase" | cut -d@ -f2 | cut -d/ -f2)
    dbuser=$(echo "$dbase" | cut -d: -f2 | cut -d/ -f3)
    dbpass=$(echo "$dbase" | cut -d: -f3 | cut -d@ -f1)
    dbhost=$(echo "$dbase" | cut -d@ -f2 | cut -d/ -f1)
    dbdriv=$(echo "$dbase" | cut -d: -f1)
    prefix=$(awk '($1 ~ /db_prefix/) {print $3}' $config | cut -d\' -f2)

  fi

  database="${dbdriv}://${dbuser}:${dbpass}@${dbhost}/${dbname}$(if [[ -n ${prefix} ]]; then echo ."${prefix}"*; fi)"

  base_path=$(cd $sitepath || exit; pwd -P;)
  base_url=$(cd $sitepath || exit; pwd -P | sed 's:/chroot::g;s:/html::g' | cut -d/ -f4-)
  sitename=$(mysql -u "$dbuser" -p"$dbpass" "$dbname" -h "$dbhost" -e "select name,value from ${prefix}variable where name=\"site_name\";" | tail -1 | cut -d\" -f2)
  posts=$(mysql -u "$dbuser" -p"$dbpass" "$dbname" -h "$dbhost" -e "select count(*) from ${prefix}node;" | tail -1)

  echo;
  printf "%-18s: %s\n" "Base Path" "${base_path}"
  printf "%-18s: %s\n" "Site Title" "${sitename}"
  printf "%-18s: %s\n" "Install Date" "${installdate}"
  printf "%-18s: %s\n" "Version" "${version}"
  printf "%-18s: %s\n" "Front End URL" "http://${base_url}"
  printf "%-18s: %s\n" "Back End URL" "http://${base_url}/admin"
  printf "%-18s: %s\n" "Post Count" "${posts}"
  printf "%-18s: %s\n" "DB Connection" "${database}"
  echo;

else
  echo -e "\nCould not find Drupal install at ${sitepath}\n";
fi

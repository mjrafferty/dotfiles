#! /bin/bash

# Script Arguments
readonly ARGS="$*"
readonly ARGA=("$@")

# Configurable Variables
readonly SPLIT_SIZE="20"
readonly ARCHIVE_SUFFIX=".tgz"

_usage() {
  cat <<- EOF

  Usage: sendthis <targetname> <subject> <emailaddr>

EOF
}

_validateInput() {

  address="$1"
  target="$2"

  if ! echo "$address" | grep -Pq '\S+@\S+\.\S+'; then
    echo "Email address invalid";
    exit 1;
  fi

  if [[ (  ! -e "${PWD}/$target" && ! -e "$target" ) || -z "$target" ]]; then
    echo "Target does not exist";
    exit 1;
  fi

}

_compressTarget() {

  local target size proceed

  target="$1";

  tar -cf - "$target" | pigz > "${target}${ARCHIVE_SUFFIX}"

  size="$(stat -c "%s" "${target}${ARCHIVE_SUFFIX}")";

  if (( size > (SPLIT_SIZE * 1024 * 1024) )); then
    read -rp "Archive is $((size / 1024 / 1024))M. Proceed? (N,y)" proceed;
    if [[ "$proceed" == "y" ]]; then
      split -d -b "${SPLIT_SIZE}M" "${target}${ARCHIVE_SUFFIX}" "${target}${ARCHIVE_SUFFIX}." \
        && rm "${target}${ARCHIVE_SUFFIX}"
    else
      rm "${target}${ARCHIVE_SUFFIX}"
      exit;
    fi
  fi
}

main () {

  local subject target address

  for ((x=0;x<${#ARGA[@]};x++)); do

    if [[ -z "$target" ]]; then
      if [[ -e "${PWD}/${ARGA[$x]}" ]]; then
        target="${PWD}/${ARGA[$x]}";
        continue;
      elif [[ -e "${ARGA[$x]}" ]]; then
        target="${ARGA[$x]}";
        continue;
      fi
    fi

    if [[ -z "$address" ]]; then
      address="$(echo "${ARGA[$x]}" | grep -Po '\S+@\S+\.\S+')" \
        && continue;
    fi

    [[ -z "$subject" ]] && subject="${ARGA[$x]}"

  done

  [[ -z "$target" ]] && read -rp "File/Directory: " target;
  [[ -z "$subject" ]] && read -rp "Subject: " subject;
  [[ -z "$address" ]] && read -rp "Email: " address;

  _validateInput "$address" "$target"

  _compressTarget "$target"

  #if grep -Fqi 'CentOS release 6' /etc/redhat-release; then
    #echo "See Attached" \
      #| mail -s "$subject" -a "$target" "$address";
  #else
    #mail -s "$subject" "$address" < "$target";
  #fi;

}

main;

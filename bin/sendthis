#! /bin/bash

# Script Arguments
readonly ARGS="$*"
readonly ARGA=("$@")

# Configurable Variables
readonly SPLIT_SIZE="20"
readonly ARCHIVE_SUFFIX=".tgz"

# Alias executables to prevent PATH issues
alias cat="/bin/cat"
alias grep="/bin/grep"
alias mail="/bin/mail"
alias rm='/bin/rm --preserve-root'
alias sha1sum="/usr/bin/sha1sum"
alias split="/usr/bin/split"
alias stat="/usr/bin/stat"
alias tar="/bin/tar"

if [[ -e /usr/bin/pigz ]]; then
  alias gzip='/usr/bin/pigz';
else
  alias gzip='/bin/gzip';
fi

# Print usage info
_usage() {
  cat <<- EOF

  Usage: sendthis <targetname> <subject> <emailaddr>

EOF
}

# Validate user input
_validateInput() {

  address="$1"
  target="$2"

  if ! echo "$address" | grep -Pq '\S+@\S+\.\S+'; then
    echo "Email address invalid";
    exit 1;
  fi

  if [[ (  ! -e "${PWD}/$target" && ! -e "$target" ) || -z "$target" ]]; then
    echo "Target does not exist";
    exit 1;
  fi

}

# Compress target file/directory and split if necessary
_compressTarget() {

  local target size proceed

  target="$1";

  printf "Compressing target..."

  tar -cf - "$target" 2> /dev/null | pigz > "${target}${ARCHIVE_SUFFIX}"

  printf "Done\n"

  size="$(stat -c "%s" "${target}${ARCHIVE_SUFFIX}")";


  if (( size > (SPLIT_SIZE * 1024 * 1024) )); then
    read -rp "Archive is $((size / 1024 / 1024))M. Proceed? (N,y)" proceed;
    if [[ "$proceed" == "y" ]]; then
      sha1sum "${target}${ARCHIVE_SUFFIX}" > "${target}${ARCHIVE_SUFFIX}.SHA1"
      split -d -b "${SPLIT_SIZE}M" "${target}${ARCHIVE_SUFFIX}" "${target}${ARCHIVE_SUFFIX}." \
        && rm "${target}${ARCHIVE_SUFFIX}"
    else
      rm "${target}${ARCHIVE_SUFFIX}"
      exit;
    fi
  fi
}

# Send target
_send() {

  local subject target address

  subject="$1"
  target="$2"
  address="$3"

  for x in ${target}${ARCHIVE_SUFFIX}*; do
    if grep -Fqi 'CentOS release 6' /etc/redhat-release; then
      echo "See Attached" \
        | mail -s "$subject" -a "$x" "$address";
    else
      mail -s "$subject" "$address" < "$x";
    fi;
  done

}

# Clean up temporary files
_cleanUp() {

  local target

  target="$1"

  rm "${target}${ARCHIVE_SUFFIX}"*

}

# Main
main () {

  local subject target address target_dir

  # Parse command line arguments
  for ((x=0;x<${#ARGA[@]};x++)); do

    if [[ -z "$target" ]]; then
      if [[ -e "${PWD}/${ARGA[$x]}" ]]; then
        target="${PWD}/${ARGA[$x]}";
        continue;
      elif [[ -e "${ARGA[$x]}" ]]; then
        target="${ARGA[$x]}";
        continue;
      fi
    fi

    if [[ -z "$address" ]]; then
      address="$(echo "${ARGA[$x]}" | grep -Po '\S+@\S+\.\S+')" \
        && continue;
    fi

    [[ -z "$subject" ]] && subject="${ARGA[$x]}"

  done
  # Ask for any data not provided on command line
  [[ -z "$target" ]] && read -rp "File/Directory: " target;
  [[ -z "$subject" ]] && read -rp "Subject: " subject;
  [[ -z "$address" ]] && read -rp "Email: " address;

  _validateInput "$address" "$target"

  target_dir="${${target%/}%/*}"
  target="${${target%/}##*/}"

  cd "$target_dir" || return 1;

  _compressTarget "$target"

  _send "$subject" "$target" "$address"

  _cleanUp "$target";

}

main;

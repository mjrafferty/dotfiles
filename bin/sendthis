#! /bin/bash

# Script Arguments
readonly ARGS="$*"
readonly ARGA=("$@")

# Configurable Variables
readonly SPLIT_SIZE="20"
readonly ARCHIVE_SUFFIX=".tgz"

# Alias executables to prevent PATH issues
alias cat="/bin/cat"
alias grep="/bin/grep"
alias mail="/bin/mail"
alias rm='/bin/rm --preserve-root'
alias sha1sum="/usr/bin/sha1sum"
alias split="/usr/bin/split"
alias stat="/usr/bin/stat"
alias tar="/bin/tar"

if [[ -e /usr/bin/pigz ]]; then
  alias gzip='/usr/bin/pigz';
else
  alias gzip='/bin/gzip';
fi

# Necessary Global Variables
FILES=();

# Print usage info
_usage() {
  cat <<- EOF

  Usage: sendthis <filenames> <subject> <emailaddr>

EOF
}

# Validate user input
_validateInput() {

  address="$1"

  if ! echo "$address" | grep -Pq '\S+@\S+\.\S+'; then
    echo "Email address invalid";
    exit 1;
  fi

  if [[ -n ${FILES[0]} ]]; then

    for x in ${FILES[*]}; do

      if [[ ! -e "${PWD}/${x}" && ! -e "$x" ]]; then
        echo "$x does not exist";
        exit 1;
      fi

    done
  else

    echo "No file given";

  fi

}

# Compress FILES file/directory and split if necessary
_compressFiles() {

  local size proceed

  printf "Compressing files..."

  tar -cf - ${FILES[*]} 2> /dev/null | pigz > "${FILES[0]}${ARCHIVE_SUFFIX}"

  printf "Done\n"

  size="$(stat -c "%s" "${FILES[0]}${ARCHIVE_SUFFIX}")";

  if (( size > (SPLIT_SIZE * 1024 * 1024) )); then

    read -rp "Archive is $((size / 1024 / 1024))M. Proceed? (N,y)" proceed;

    if [[ "$proceed" == "y" ]]; then

      sha1sum "${FILES[0]}${ARCHIVE_SUFFIX}" > "${FILES[0]}${ARCHIVE_SUFFIX}.SHA1"

      split -d -b "${SPLIT_SIZE}M" "${FILES[0]}${ARCHIVE_SUFFIX}" "${FILES[0]}${ARCHIVE_SUFFIX}." \
        && rm "${FILES[0]}${ARCHIVE_SUFFIX}"

    else

      rm "${FILES[0]}${ARCHIVE_SUFFIX}"
      exit;

    fi
  fi

}

# Send FILES
_send() {

  local subject address

  subject="$1"
  address="$2"

  for x in ${FILES[0]}${ARCHIVE_SUFFIX}*; do

    if grep -Fqi 'CentOS release 6' /etc/redhat-release; then

      echo "See Attached" \
        | mail -s "$subject" -a "$x" "$address";

    else

      mail -s "$subject" "$address" < "$x";

    fi;
  done

}

# Clean up temporary files
_cleanUp() {

  rm "${FILES[0]}${ARCHIVE_SUFFIX}"*

}

# Main
main () {

  local subject address longest_common_path word_array


  # Parse command line arguments
  for ((x=0;x<${#ARGA[@]};x++)); do

    if [[ -e "${PWD}/${ARGA[x]}" && ! "${ARGA[x]}" == "/"* ]]; then

      FILES+=("${PWD}/${ARGA[x]}");
      continue;

    elif [[ -e "${ARGA[x]}" ]]; then

      FILES+=("${ARGA[x]}");
      continue;

    fi

    if [[ -z "$address" ]]; then

      address="$(echo "${ARGA[x]}" | grep -Po '\S+@\S+\.\S+')" \
        && continue;

    fi

    [[ -z "$subject" ]] && subject="${ARGA[x]}"

  done

  # Ask for any data not provided on command line
  [[ -z "${FILES[0]}" ]] && read -rp "File/Directory: " FILES;
  [[ -z "$subject" ]] && read -rp "Subject: " subject;
  [[ -z "$address" ]] && read -rp "Email: " address;

  _validateInput "$address"

  word_array=($(echo "${FILES[0]}" | sed 's/\//& /g'))
  longest_common_path="${#word_array[@]}";

  if [[ -n ${FILES[1]} ]]; then
    for ((y=1; y<${#FILES[@]};y++)); do

      local word_array2 long;

      word_array2=($(echo "${FILES[y]}" | sed 's/\//& /g'))

      for((long=0;long < longest_common_path;long++)); do

        if [[ "${word_array[long]}" == "${word_array2[long]}" ]]; then

          continue;

        else

          longest_common_path=$long;
          break;

        fi
      done
    done

    longest_common_path=$((longest_common_path - 1))

    cd_dir="$(echo "${FILES[0]}" | grep -Po "^/([^/]*/){$longest_common_path}")";

    for ((i=0; i<${#FILES[@]};i++)); do
      FILES[i]=${FILES[i]##$cd_dir};
    done

  else

    cd_dir="${FILES[0]%/*}";
    FILES[0]="${FILES[0]##*/}"

  fi

  cd "$cd_dir" || return 1;

  _compressFiles;

  _send "$subject" "$address"

  _cleanUp;

}

main;

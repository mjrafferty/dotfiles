#! /bin/bash

## Generate or update .htpasswd file to add username

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF

  Usage: htpasswdauth [-u|--user username] [-p|--pass password] [-l length]

  Ex: htpasswdauth -u username -p passwod
  Ex: htpasswdauth -u username -l 5
  Ex: htpasswdauth -u username

EOF
}

main () {

  if [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local user pass;

  # Get username
  if [[ -z ${ARGA[0]} ]]; then
    echo;
    read -rp "Username: " user;
  elif [[ ${ARGA[0]} == '-u' || ${ARGA[0]} == '--user' ]]; then
    user="${ARGA[1]}";
  fi;

  # Set password
  if [[ -z ${ARGA[2]} ]]; then
    pass=$(xkcd);
  elif [[ ${ARGA[2]} == '-p' || ${ARGA[2]} == '--pass' ]]; then
    pass="${ARGA[3]}";
  elif [[ ${ARGA[2]} == '-l' ]]; then
    pass=$(xkcd -l "${ARGA[3]}");
  fi

  # Write information to file
  if [[ -f .htpasswd ]]; then
    sudo -u "$(getusr)" htpasswd -mb .htpasswd "$user" "$pass";
  else
    sudo -u "$(getusr)" htpasswd -cmb .htpasswd "$user" "$pass";
  fi;

  # Display configured username and password
  echo -e "\nUsername: $user\nPassword: $pass\n";

}

main;

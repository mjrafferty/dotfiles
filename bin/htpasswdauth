#! /bin/bash

## Generate or update .htpasswd file to add username

readonly ARGS="$*"
readonly ARGA=("$@")

readonly PREFIX=".htpasswd"

_usage() {
  cat <<- EOF

  Usage: htpasswdauth [-u|--user username] [-p|--pass password] [-l length]

  Ex: htpasswdauth -u username -p passwod
  Ex: htpasswdauth -u username -l 5
  Ex: htpasswdauth -u username

EOF
}

main () {

  local user pass protected_dir site_dir filename;

  for ((x=0;x<${#ARGA[@]};x++)); do
    case "${ARGA[$x]}" in
      "-h"|"--help")
        _usage;
        exit;
        ;;
      "-u"|"--user")
        user="${ARGA[$((++x))]}";
        ;;
      "-p"|"--pass")
        pass="${ARGA[$((++x))]}";
        ;;
      "-d"|"--directory")
        dir="${ARGA[$((++x))]}";
        ;;
      *);;
    esac
  done


  # Get username
  if [[ -z "$user" ]]; then
    read -rp "Username: " user;
  fi;

  # Set password
  if [[ -z "$pass" ]]; then
    pass=$(xkcd);
  fi

  if [[ -z "$protected_dir" ]]; then
    protected_dir="$(pwd)";
  fi

  site_dir="$(echo "$protected_dir" | grep -Po '.*home/[^/]*/[^/]*')"
  filename="${site_dir}/${PREFIX}_$(echo "$protected_dir" | grep -Po 'html/\K.*' | tr '/' '-')"

  # Write information to file
  if [[ -f "$filename" ]]; then
    sudo -u "$(getusr)" htpasswd -mb "$filename" "$user" "$pass";
  else
    sudo -u "$(getusr)" htpasswd -cmb "$filename" "$user" "$pass";
  fi;

  # Display configured username and password
  echo -e "\nUsername: $user\nPassword: $pass\n";

}

main;

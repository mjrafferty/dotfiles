#! /bin/bash

## Look up what domain is covered by the SSL loading at the requested domain

if [[ $2 == '-p' ]]; then
  P=$3;
else
  P=443;
fi

if [[ "$*" =~ -v ]]; then
  type="subject issuer";
else
  type="subject";
fi

D=$(echo "$1" | sed 's/\///g');

echo;

echo "$D:$P";

dashes 80;

echo;

if [[ $(cat /etc/redhat-release) =~ 6\.[0-9] ]]; then
  SNI="-servername $D";
fi;

for x in $type; do

  echo \
    | openssl s_client -nbio -connect "$D:$P" "$SNI" 2> /dev/null\
    | grep $x | sed 's/ /_/g;s/\/\([A-Ze]\)/\n\1/g;s/=/: /g' \
    | grep "^[A-Ze]" \
    | column -t \
    | sed 's/_/ /g';

  echo;

done

echo "SSL Return Code";

dashes 80;

echo;

rcode=$(echo | openssl s_client -nbio -connect "$D:$P" "$SNI" 2>/dev/null | grep "Verify.*");

echo "$rcode";

if [[ $(echo "$rcode" | awk '{print $4}') =~ [0-9]{2} ]]; then

  curl -s https://www.openssl.org/docs/apps/verify.html \
    | grep -A4 "$(echo "$rcode" \
    | awk '{print $4}') X509" \
    | grep -v X509 \
    | sed 's/<[^>]*>//g' \
    | tr '\n' ' ';

  echo;

fi;

echo -e "\nhttps://www.sslshopper.com/ssl-checker.html#hostname=${D}\nhttps://certlogik.com/ssl-checker/${D}:${P}/\n";

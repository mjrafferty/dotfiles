#! /bin/bash


## swap new ssl into place of old ssl and reload apache

domain=$(pwd -p | sed 's:/chroot::' | cut -d/ -f5)
nano ${domain}.new.crt ${domain}.new.chain.crt;

keyhash=$(openssl rsa -noout -modulus -in ${domain}.priv.key | openssl md5 | awk '{print $2}')
crthash=$(openssl x509 -noout -modulus -in ${domain}.new.crt | openssl md5 | awk '{print $2}')

if [[ $keyhash != $crthash ]]; then
	rm ${domain}.new.crt ${domain}.new.chain.crt
	echo -e "\n[${bright}${red}failed${normal}] .. ssl does not match priv.key!\n\npriv.key .. [${yellow}${keyhash}${normal}]\nssl.cert .. [${yellow}${crthash}${normal}]\n";

else
	echo -e "\n[${bright}${green}update${normal}] .. ssl certificate"
	rm ${domain}.crt 2> /dev/null; mv ${domain}{.new.crt,.crt}
	chmod 600 ${domain}.crt; chown iworx. ${domain}.crt

	# check if new chain cert exists and is non-zero; then remove and replace the old one
	if [[ -f ${domain}.new.chain.crt && -n $(cat ${domain}.new.chain.crt 2> /dev/null) ]]; then
		echo "[${bright}${green}update${normal}] .. chain certificate"
		rm ${domain}.chain.crt 2> /dev/null; mv ${domain}{.new.chain.crt,.chain.crt}
		chmod 600 ${domain}.chain.crt; chown iworx. ${domain}.chain.crt
	fi

	# check if new chain cert exists and is non-zero; then install new ssl with chain, else exclude chain
	if [[ -f ${domain}.chain.crt && -n $(cat ${domain}.chain.crt 2> /dev/null) ]]; then
		sudo -u $(getusr) siteworx -unc ssl -a install --domain $domain --chain 1
	else
		sudo -u $(getusr) siteworx -unc ssl -a install --domain $domain --chain 0
	fi

	echo -e "[${bright}${green}reload${normal}] .. ssl update successful\n"
	echo -e "\nhttps://www.sslshopper.com/ssl-checker.html#hostname=${domain}\nhttps://certlogik.com/ssl-checker/${domain}:443/\n"
fi

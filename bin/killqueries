#! /bin/bash
readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF

  Usage: killqueries [sleep|select]

EOF
}

source /etc/nexcess/shell_functions.sh;

_querieslog () {

  local filename="$1"

  mytop -b --nocolor > ~/"$filename";

  echo -e "\n~/$filename created ...\nBegin killing queries ...";
}

main () {

  local filename x i;

  filename="mytop-dump--$(date +%Y.%m.%d-%H.%M).dump";

  case ${ARGA[0]} in
    "sel"|"select")
      _querieslog "$filename";

      x=$(awk '/SELECT/ {print $1}' ~/"$filename");

      for i in $x; do
        echo "Killing: $i";
        m -e"kill $i";
      done;

      echo -e "Operation completed.\n";
      ;;
    "sle"|"sleep")
      _querieslog "$filename";

      x=$(awk '/Sleep/ {print $1}' ~/"$filename");

      for i in $x; do
        echo "Killing $i";
        m -e"kill $i";
      done;

      echo -e "Operation completed.\n";
      ;;
    "-h"|"--help"|"*")
      _usage;
      ;;
  esac

}

main;

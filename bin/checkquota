#! /bin/bash

## Check users quota usage
_quotaheader () {
	echo;
	printf "%8s %12s %14s %14s\n" "Username" "Used(%)" "Used(G)" "Total(G)";
	dash 51;
}
_quotausage () {
	printf "\n%-10s" "$1";
	quota -g $1 2> /dev/null | tail -1 | awk '{printf "%10.3f%%  %10.3f GB  %10.3f GB",($2/$3*100),($2/1000/1024),($3/1000/1024)}' 2> /dev/null;
}
case $1 in
	-h|--help   )
		echo -e "\n Usage: checkquota [--user <username>|--all|--large]\n   -u|--user user1 [user2..] .. Show quota usage for a user or list of users \n   -a|--all ................... List quota usage for all users\n   -l|--large ................. List all users at or above 80% of quota\n";;
	-a|--all    )
		_quotaheader;
		for x in $(laccounts); do
			_quotausage $x;
		done | sort; echo ;;
	-l|--large  )
		_quotaheader;
		echo;
		for x in $(laccounts); do
			_quotausage $x;
		done | sort | grep -E '[8,9][0-9]\..*%|1[0-9]{2}\..*%';
		echo ;;
	-u|--user|* )
		_quotaheader;
		shift;
		if [[ -z "$@" ]]; then
			_quotausage $(getusr);
		else
			for x in "$@"; do
				_quotausage $x;
			done;
		fi;
		echo;
		echo ;;
esac

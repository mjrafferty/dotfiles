#! /bin/bash

# Script Arguments
readonly ARGS="$*"
readonly ARGA=("$@")

# Configurable Variables
CONFIG_FILE="app/etc/local.xml"
DEFAULTS_FILE="$HOME/.magdb_defaults"

# Alias executables to prevent PATH issues
readonly AWK="/bin/awk"
readonly CAT="/bin/cat"
readonly CHMOD='/bin/chmod'
readonly CUT="/bin/cut"
readonly FOLD="/usr/bin/fold"
readonly GREP="/bin/grep"
readonly HEAD="/usr/bin/head"
readonly LESS='/usr/bin/less'
readonly MYSQL="/usr/bin/mysql"
readonly RM="/bin/rm"
readonly SED="/bin/sed"
readonly SHUF="/usr/bin/shuf"
readonly TAIL="/usr/bin/tail"
readonly TOUCH="/bin/touch"
readonly TPUT="/usr/bin/tput"
readonly TR="/usr/bin/tr"
readonly WC="/usr/bin/wc"

BRIGHT=$("$TPUT" bold);
NORMAL=$("$TPUT" sgr0);
RED=$("$TPUT" setaf 1);
GREEN=$("$TPUT" setaf 10);

# Necessary Global Variables
DBHOST=""
DBUSER=""
DBPASS=""
DBNAME=""
PREFIX=""

if [[ -e $CONFIG_FILE ]]; then
  SITEPATH="$PWD"
else
  SITEPATH="$(pwd | "$GREP" -Po '(/chroot)?/home(/[^/]+){2}')"
fi

# Print usage
_usage() {

  "$CAT" <<- EOF

  Usage: magdb <option>

    -i | --info        Display user credentials for database
    -l | --login       Log into database using user credentials

    -A | --admin       Add a new admin user into the database
    -P | --password    Update or reset password for user
    -u | --users       Show all Admin Users' information

    -b | --base        Show all configured Base Urls
    -m | --multi       Show Multistore Information (Urls/Codes)
    -O | --cookie      Show cookie configuration

    -c | --cron        Show Cron Jobs and Their Statuses

    -p | --products    Show products
    -o | --orders      Show recent orders
    -s | --shipment    Show recent shipments
    -q | --quotes      Show recent quotes
    -I | --invoices    Show recent invoices
    -g | --categories  Show category information
    -C | --customers   Show customers

    -L | --logsize     Show size of the log tables
    -T | --truncate    Truncate and optimize log tables
    -x | --index       Show Current Status of all Re-Index Processes

    -h | --help        Display this help output and quit

EOF

}

# Convert long command line options into short ones for getopts
_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      "--admin"|"-A")
        args="${args}-A "
        ;;
      "--base"|"-b")
        args="${args}-b "
        ;;
      "--cron"|"-c")
        args="${args}-c "
        ;;
      "--info"|"-i")
        args="${args}-i "
        ;;
      "--login"|"-l")
        args="${args}-l "
        ;;
      "--logsize"|"-L")
        args="${args}-L "
        ;;
      "--multi"|"-m")
        args="${args}-m "
        ;;
      "--truncate"|"-T")
        args="${args}-T "
        ;;
      "--password"|"-P")
        args="${args}-P "
        ;;
      "--users"|"-u")
        args="${args}-u "
        ;;
      "--index"|"-x")
        args="${args}-x "
        ;;
      "--products"|"-p")
        args="${args}-p "
        ;;
      "--orders"|"-o")
        args="${args}-o "
        ;;
      "--shipment"|"-s")
        args="${args}-s "
        ;;
      "--cookie"|"-O")
        args="${args}-O "
        ;;
      "--quotes"|"-q")
        args="${args}-q "
        ;;
      "--invoices"|"-I")
        args="${args}-I "
        ;;
      "--categories"|"-g")
        args="${args}-g "
        ;;
      "--customers"|"-C")
        args="${args}-C "
        ;;
      "--address"|"-a")
        args="${args}-a "
        ;;
      *)
        args="${args}${x} "
        ;;
    esac
  done

  echo "$args";

}

# Generate Password
_xkcd () {

  local wordList word rnd pass matchList wcount

  if [ -r /usr/local/interworx/lib/dict/words ]; then

    wordList='/usr/local/interworx/lib/dict/words';

  elif [ -r /usr/share/dict/words ]; then

    wordList='/usr/share/dict/words';

  else
    return 1;
  fi

  if [[ -x /usr/bin/shuf ]]; then

    pass=$("$SHUF" -n1000 "$wordList" | "$GREP" -E '^[a-z,A-Z]{4,12}$' | "$HEAD" -n4 | "$SED" 's/^\([a-z]\)/\u\1/' | "$TR" -d '\n| ');

    echo "$pass"$(( (RANDOM % 9000) + 1000 ));

  else

    word=();

    matchList=$("$GREP" -E '^[a-z,A-Z]{4,12}$' $wordList);
    IFS=" "
    wcount=$(echo "$matchList" | "$WC" -l | "$AWK" '{print $1}')

    for ((x=0;x<4;x++)) do

      rnd=$((RANDOM % wcount))

      word[$x]=$(echo "$matchList" | "$SED" -n "${rnd}p" | "$SED" 's/^\([a-z]\)/\u\1/');

    done;

    echo "${word[0]}${word[1]}${word[2]}${word[3]}$(( RANDOM % 9000 + 1000 ))";

  fi

}

# Parse local.xml
_awkConfig () {
  "$AWK" '
  BEGIN {
    beginConfig=0;
    endConfig=0;
  }
  {
    if ( beginConfig == 0 ){
      if (match($0,"<connection>")){

        beginConfig=1;
      }
    } else if( endConfig == 0 ){
      gsub(/(<!\[CDATA\[|\]\]>)/,"",$1);

      if (match($0,"</connection>")){
        endConfig=1;
      } else {
      if (match($1,"<host>")) {
        gsub(/(.*<host>|<\/host>.*)/,"",$1);
        config["host"]=$1
      }
      else if (match($1,"<username>")) {
        gsub(/(.*<username>|<\/username>.*)/,"",$1);
        config["username"]=$1
      }
      else if (match($1,"<password>")) {
        gsub(/(.*<password>|<\/password>.*)/,"",$1);
        config["password"]=$1
      }
      else if (match($1,"<dbname>")) {
        gsub(/(.*<dbname>|<\/dbname>.*)/,"",$1);
        config["dbname"]=$1
      }
    }
  }
    if (match($1,"<table_prefix>")) {
      gsub(/(<!\[CDATA\[|\]\]>)/,"",$1);
      gsub(/(.*<table_prefix>|<\/table_prefix>.*)/,"",$1);
      config["table_prefix"]=$1
    }
  }
  END {

    printf("%s\n%s\n%s\n%s\n%s\n",config["host"],config["username"],config["password"],config["dbname"],config["table_prefix"]);

  }'
}

# Grab data from local.xml
_getConfig () {

  local config

  if [[ -f $SITEPATH/$CONFIG_FILE ]]; then #Magento

    mapfile -t config < <("$GREP" -Pv '^\s*(<!|\*)' $CONFIG_FILE | _awkConfig);

    DBHOST="${config[0]}"
    DBUSER="${config[1]}"
    DBPASS="${config[2]}"
    DBNAME="${config[3]}"
    PREFIX="${config[4]}"

  else

    echo "${RED}Could not find configuration file!${NORMAL}";
    exit 1;

  fi;
}

# Print summary
_summary () {

  local version edition ver

  mapfile -t ver < <("$GREP" 'function getVersionInfo' -A8 "$SITEPATH"/app/Mage.php | "$GREP" major -A4 | "$CUT" -d\' -f4);
  version="${ver[0]}.${ver[1]}.${ver[2]}.${ver[3]}"

  if "$GREP" -qE '(Enterprise|Commercial) Edition' "$SITEPATH"/app/Mage.php; then
    edition="Enterprise Edition";
  else
    edition="Community Edition";
  fi

  "$CAT" <<-EOF

  ${BRIGHT}$edition: ${GREEN}${version}${NORMAL}
  ${BRIGHT}Connection Summary: ${GREEN}${DBUSER}:${DBNAME}${NORMAL}

EOF

}

# Make "$MYSQL" defaults file
_makeDefaultsFile () {

  "$CAT" <<- EOF > "$DEFAULTS_FILE"
[client_magdb]
database = "$DBNAME"
user =  "$DBUSER"
password = "$DBPASS"
host = "$DBHOST"
EOF

  "$CHMOD" 600 "$DEFAULTS_FILE"

}

# Connect to the database
_connect () {

  _summary;

  "$MYSQL" --defaults-extra-file="$DEFAULTS_FILE" --defaults-group-suffix="_magdb" -t "$@" | "$LESS" -RSF;

}

# Connect to the database interactively
_connecti () {

  _summary;

  "$MYSQL" --defaults-extra-file="$DEFAULTS_FILE" --defaults-group-suffix="_magdb";

}

# Add an administrator
_admin () {

  local firstname lastname emailaddr username password salt;

  read -rp "Firstname: " firstname;
  read -rp "Lastname: " lastname;
  read -rp "Email: " emailaddr;
  read -rp "Username: " username;

  password=$(_xkcd);
	salt="$("$TR" -dc 'a-zA-Z0-9' < /dev/urandom | "$FOLD" -w 32 | "$HEAD" -n1)"

  _connect <<- EOF

  INSERT INTO ${PREFIX}admin_user (firstname,lastname,email,username,password)
  VALUES ("$firstname","$lastname","$emailaddr","$username",CONCAT(MD5("${salt}${password}"), ":${salt}"));

  INSERT INTO ${PREFIX}admin_role (parent_id,tree_level,sort_order,role_type,user_id,role_name)
  VALUES (1,2,0,"U",(SELECT user_id FROM ${PREFIX}admin_user where username="$username"),"$username");

EOF

  "$CAT" <<- EOF

  Username: $username
  Password: $password

EOF

}

# Print base url's
_base () {

  _connect <<- EOF

	SELECT *
	FROM ${PREFIX}core_config_data
	WHERE path like "web/secure%"
	or path like "web/unsecure%"
	order by scope_id asc,path desc;

EOF

}

# Print cron table
_cron () {

  _connect <<- EOF

  SELECT *
  FROM ${PREFIX}cron_schedule;

EOF

}

# Print database info
_info () {

  "$CAT" <<- EOF
  ${BRIGHT}Database Info:${NORMAL}

  ${BRIGHT}Username:${NORMAL} $DBUSER
  ${BRIGHT}Password:${NORMAL} $DBPASS
  ${BRIGHT}Database:${NORMAL} $DBNAME
  ${BRIGHT}Hostname:${NORMAL} $DBHOST
  ${BRIGHT}Prefix  :${NORMAL} $PREFIX

EOF

}

# Login to database
_login () {

  _connecti;

}

# Show log table sizes
_logsize () {

  local datatotal indextotal rowtotal tables div datasize indexsize rowcount

  _summary;

  datatotal=0;
  indextotal=0;
  rowtotal=0;

  tables="log_customer log_visitor log_visitor_info log_url log_url_info log_quote report_viewed_product_index report_compared_product_index report_event catalog_compare_item";

  div='+------------------------------------------+-----------------+----------------+----------------+'

  printf "%s\n| %-40s | %15s | %12s M | %12s M |\n%s\n" "$div" "Table Name" "Row Count" "Data Size" "Index Size" "$div";

  for x in $tables; do

    datasize=$(_connect -e "SELECT data_length/1024000 FROM information_schema.TABLES WHERE table_name = \"${PREFIX}$x\" and TABLE_SCHEMA=\"$DBNAME\";" | "$TAIL" -n1)
    indexsize=$(_connect -e "SELECT index_length/1024000 FROM information_schema.TABLES WHERE table_name = \"${PREFIX}$x\" and TABLE_SCHEMA=\"$DBNAME\";" | "$TAIL" -n1)
    rowcount=$(_connect -e "SELECT table_rows FROM information_schema.TABLES WHERE table_name = \"${PREFIX}$x\" and TABLE_SCHEMA=\"$DBNAME\";" | "$TAIL" -n1)

    datatotal=$(echo "scale=3;$datatotal + $datasize" | bc)
    indextotal=$(echo "scale=3;$indextotal+$indexsize" | bc)
    rowtotal=$((rowcount+rowtotal))

    printf "| %-40s | %15s | %12s M | %12s M |\n" "$x" "$rowcount" "$datasize" "$indexsize"

  done

  printf "%s\n| %-40s | %15s | %12s M | %12s M |\n%s\n" "$div" "Totals" "$rowtotal" "$datatotal" "$indextotal" "$div";

}

# Print multistore config
_multi () {

  _connect <<- EOF

  SELECT *
  FROM ${PREFIX}core_config_data
  WHERE path LIKE "%base_url"
  order by scope_id asc,path desc;

  SELECT *
  FROM ${PREFIX}core_website;

  SELECT *
  FROM ${PREFIX}core_store_group;

  SELECT *
  FROM ${PREFIX}core_store;

EOF

}

# Truncate and optimize log tables
_truncate () {

  local tables;

  tables="core_cache core_cache_option core_cache_tag core_session dataflow_batch_import dataflow_batch_export\
    index_process_event log_customer log_quote log_summary log_summary_type\
    log_url log_url_info log_visitor log_visitor_info log_visitor_online\
    report_viewed_product_index report_compared_product_index report_event catalog_compare_item"

  "$TOUCH" "$SITEPATH"/maintenance.flag && echo -e "Maintenance Flag set while cleaning tables\n";

  for x in $tables; do
    echo;
    echo "Truncating/Optimizing ${PREFIX}$x";
    _connect -e "TRUNCATE ${PREFIX}$x; OPTIMIZE TABLE ${PREFIX}$x;" >> /dev/null;
  done;


  if [[ -f $SITEPATH/maintenance.flag ]]; then
    "$RM" "$SITEPATH"/maintenance.flag \
      && echo -e "\nTable cleaning complete, maintenance.flag removed";
  fi;

}

# Change admin user password
_password () {

  local username password salt;

  username="$1"

  read -rp "New password (default: xkcd): " password;

  if [ -z "$password" ]; then
    password="$(_xkcd)";
  fi

	salt="$("$TR" -dc 'a-zA-Z0-9' < /dev/urandom | "$FOLD" -w 32 | "$HEAD" -n1)"

  _connect <<- EOF

	UPDATE ${PREFIX}admin_user
  SET password = CONCAT(MD5("${salt}${password}"), ":${salt}")
  WHERE username = "$username";

EOF

  "$CAT" <<- EOF

  New Magento Login Credentials:

  Username: $username
  Password: $password

EOF

}

# Show admin users
_users () {

	_connect <<- EOF

  select
    P.role_name, username,
    firstname,lastname,
    email,created,
	  modified,logdate,
    lognum,is_active
	from ${PREFIX}admin_role U
	inner join ${PREFIX}admin_role P on U.parent_id=P.role_id
	inner join ${PREFIX}admin_user on U.user_id=admin_user.user_id
	order by role_name,lognum desc;

EOF

}

# List product info
_products () {

  local attributes atts a search where;

  attributes=( "name" "status" "visibility" "image" "url_key" )

  for((a=0;a<${#attributes[*]};a++)); do
    atts+=" \"${attributes[a]}\""
    if (( a < (${#attributes[*]} - 1) )); then
      atts+=",";
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#attributes[*]};w++)); do
      where+=" ${attributes[w]} rlike \"${search}\""
      if (( w < (${#attributes[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

	CREATE TEMPORARY TABLE CPEA (
    KEY (attribute_id)
  ) as
    (select *
    from ${PREFIX}catalog_product_entity_varchar);

  INSERT INTO CPEA
    (select *
    from ${PREFIX}catalog_product_entity_int);


  create temporary table PROD_ATTS (
    KEY (entity_id)
  )
  select
    store_id,
    entity_id,
    GROUP_CONCAT(if(EA.attribute_code="name",value,NULL)) as name,
    GROUP_CONCAT(if(EA.attribute_code="url_key",value,NULL)) as url_key,
    GROUP_CONCAT(if(EA.attribute_code="image",value,NULL)) as image,
    GROUP_CONCAT(if(EA.attribute_code="status",value,NULL)) as status,
    GROUP_CONCAT(if(EA.attribute_code="visibility",value,NULL)) as visibility
  from CPEA
	inner join ${PREFIX}eav_attribute as EA on EA.attribute_id=CPEA.attribute_id
	inner join ${PREFIX}eav_entity_type EAT on EAT.entity_type_id=EA.entity_type_id
	where EAT.entity_type_code="catalog_product"
	and EA.attribute_code in (${atts})
  group by store_id,entity_id;

  create temporary table PROD (
    KEY (entity_id)
  )
	select
    CPE.entity_id,
    EAS.attribute_set_name,
    CPE.type_id,
    CPE.sku,
    CPE.has_options,
    CPE.created_at,
    CPE.updated_at
	from ${PREFIX}catalog_product_entity CPE
	inner join ${PREFIX}eav_attribute_set as EAS on EAS.attribute_set_id=CPE.attribute_set_id
	inner join ${PREFIX}eav_entity_type as EAT on EAT.entity_type_id=EAS.entity_type_id;

	select
    PROD_ATTS.store_id, PROD.entity_id,
    PROD_ATTS.name, PROD.sku,
    PROD.type_id, PROD.attribute_set_name,
    PROD_ATTS.url_key, PROD_ATTS.image,
    PROD_ATTS.visibility, PROD_ATTS.status,
    PROD.has_options, PROD.created_at,
    PROD.updated_at
	from PROD
	left join PROD_ATTS on PROD.entity_id=PROD_ATTS.entity_id
  ${where}
  group by PROD_ATTS.store_id,PROD.entity_id
	order by PROD_ATTS.store_id,PROD.entity_id;

EOF

}

# List order info
_orders () {

  local columns select where s w;

  columns=("increment_id" "entity_id" "store_id" "customer_id" "customer_email" "email_sent" "total_invoiced"
  "remote_ip" "x_forwarded_for" "shipping_method" "total_item_count" "created_at" "updated_at")

  select="select"

  for((s=0;s<${#columns[*]};s++)); do
    select+=" ${columns[s]}"
    if (( s < (${#columns[*]} - 1) )); then
      select+=","
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#columns[*]};w++)); do
      where+=" ${columns[w]} rlike \"${search}\""
      if (( w < (${#columns[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

  ${select}
	from ${PREFIX}sales_flat_order
  ${where}
	order by created_at desc
	limit 100;

EOF

}

# List shipment info
_shipment () {

  local columns select where s w;

  columns=("increment_id" "entity_id" "store_id" "order_id" "email_sent"
  "shipping_address_id" "billing_address_id" "created_at" "updated_at")

  select="select"

  for((s=0;s<${#columns[*]};s++)); do
    select+=" ${columns[s]}"
    if (( s < (${#columns[*]} - 1) )); then
      select+=","
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#columns[*]};w++)); do
      where+=" ${columns[w]} rlike \"${search}\""
      if (( w < (${#columns[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

  ${select}
	from ${PREFIX}sales_flat_shipment
  ${where}
	order by created_at desc
	limit 100;

EOF

}

# List cookie info
_cookie () {

  _connect <<- EOF
  select *
  from ${PREFIX}core_config_data
  where path rlike "^web/cookie";
  select *
  from ${PREFIX}core_config_data
  where path rlike "^web/session";

EOF

}

# List quotes info
_quotes () {

  local columns select where s w;

  columns=("entity_id" "store_id" "is_active" "checkout_method" "customer_id" "customer_email"
  "remote_ip" "created_at" "updated_at")

  select="select"

  for((s=0;s<${#columns[*]};s++)); do
    select+=" ${columns[s]}"
    if (( s < (${#columns[*]} - 1) )); then
      select+=","
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#columns[*]};w++)); do
      where+=" ${columns[w]} rlike \"${search}\""
      if (( w < (${#columns[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

  ${select}
	from ${PREFIX}sales_flat_quote
  ${where}
	order by created_at desc
	limit 100;

EOF

}

# List invoice info
_invoices() {

  local columns select where s w;

  columns=("increment_id" "entity_id" "store_id" "order_id" "email_sent" "grand_total"
  "shipping_address_id" "billing_address_id" "created_at" "updated_at")

  select="select"

  for((s=0;s<${#columns[*]};s++)); do
    select+=" ${columns[s]}"
    if (( s < (${#columns[*]} - 1) )); then
      select+=","
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#columns[*]};w++)); do
      where+=" ${columns[w]} rlike \"${search}\""
      if (( w < (${#columns[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

  ${select}
	from ${PREFIX}sales_flat_invoice
  ${where}
	order by created_at desc
	limit 100;

EOF

}

# List category info
_categories () {

  local attributes atts a search where;

  attributes=( "name" "custom_design" "display_mode" "page_layout" "url_key" "url_path" "include_in_menu" "is_active" "landing_page" )

  for((a=0;a<${#attributes[*]};a++)); do
    atts+=" \"${attributes[a]}\""
    if (( a < (${#attributes[*]} - 1) )); then
      atts+=",";
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#attributes[*]};w++)); do
      where+=" ${attributes[w]} rlike \"${search}\""
      if (( w < (${#attributes[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

  CREATE TEMPORARY TABLE CCEA (
    KEY (attribute_id)
  ) as
  (
    select *
    from ${PREFIX}catalog_category_entity_varchar
  );

  INSERT INTO CCEA
  (
    select *
    from ${PREFIX}catalog_category_entity_int
  );

  create temporary table CAT_ATTS (
    KEY (entity_id)
  )
  select
		store_id,
		entity_id,
		GROUP_CONCAT(if(EA.attribute_code="name",value,NULL)) as name,
		GROUP_CONCAT(if(EA.attribute_code="url_key",value,NULL)) as url_key,
		GROUP_CONCAT(if(EA.attribute_code="url_path",value,NULL)) as url_path,
		GROUP_CONCAT(if(EA.attribute_code="custom_design",value,NULL)) as custom_design,
		GROUP_CONCAT(if(EA.attribute_code="page_layout",value,NULL)) as page_layout,
		GROUP_CONCAT(if(EA.attribute_code="display_mode",value,NULL)) as display_mode,
		GROUP_CONCAT(if(EA.attribute_code="include_in_menu",value,NULL)) as include_in_menu,
		GROUP_CONCAT(if(EA.attribute_code="is_active",value,NULL)) as is_active,
		GROUP_CONCAT(if(EA.attribute_code="landing_page",value,NULL)) as landing_page
  from CCEA
	inner join ${PREFIX}eav_attribute as EA on EA.attribute_id=CCEA.attribute_id
	inner join ${PREFIX}eav_entity_type EAT on EAT.entity_type_id=EA.entity_type_id
	where EAT.entity_type_code="catalog_category"
	and EA.attribute_code in (${atts})
  group by store_id,entity_id;

	create temporary table CAT (
    KEY (entity_id)
  )
	select
		CCE.entity_id,
		EAS.attribute_set_name,
		CCE.parent_id,
		CCE.path,
		CCE.position,
		CCE.children_count,
		CCE.created_at,
		CCE.updated_at
	from ${PREFIX}catalog_category_entity CCE
	inner join ${PREFIX}eav_attribute_set as EAS on EAS.attribute_set_id=CCE.attribute_set_id
	inner join ${PREFIX}eav_entity_type as EAT on EAT.entity_type_id=EAS.entity_type_id;

  create temporary table CAT_COUNTS (
    KEY (category_id)
  )
  select
		category_id, count(category_id) as product_count
  from ${PREFIX}catalog_category_product
  group by category_id
  order by category_id;

	select
		CAT_ATTS.store_id, CAT.entity_id,
		CAT_ATTS.name, CAT_COUNTS.product_count,
		CAT.attribute_set_name, CAT.path,
		CAT.position, CAT.children_count,
		CAT_ATTS.url_key, CAT_ATTS.url_path,
		CAT_ATTS.custom_design, CAT_ATTS.display_mode,
		CAT_ATTS.page_layout, CAT_ATTS.include_in_menu,
		CAT_ATTS.is_active, CAT_ATTS.landing_page,
		CAT.created_at, CAT.updated_at
	from CAT
	left join CAT_ATTS on CAT.entity_id=CAT_ATTS.entity_id
	left join CAT_COUNTS on CAT.entity_id=CAT_COUNTS.category_id
  ${where}
  group by CAT_ATTS.store_id,CAT.entity_id
	order by CAT_ATTS.store_id,CAT.entity_id;

EOF

}

# List customers info
_customers() {

  local columns select where s w;

  columns=("entity_id" "store_id" "website_id" "email" "group_id" "is_active"
  "created_at" "updated_at")

  select="select"

  for((s=0;s<${#columns[*]};s++)); do
    select+=" ${columns[s]}"
    if (( s < (${#columns[*]} - 1) )); then
      select+=","
    fi
  done

  read -rp "Search value: " search

  if [[ -n "$search" ]]; then
    where="where"

    for((w=0;w<${#columns[*]};w++)); do
      where+=" ${columns[w]} rlike \"${search}\""
      if (( w < (${#columns[*]} - 1) )); then
        where+=" or"
      fi
    done
  fi

  _connect <<- EOF

  ${select}
	from ${PREFIX}customer_entity
  ${where}
	order by created_at desc
	limit 100;

EOF

}

# Show indexer status
_index () {

  _connect <<- EOF

  SELECT *
  FROM ${PREFIX}index_process;

EOF

}

# Clean up before exit
_cleanUp () {

  "$RM" "$DEFAULTS_FILE";

}

# Main
main () {

  _getConfig;

  _makeDefaultsFile;

  while getopts "hAbcilLmTP:uxposOqIgCa" OPTION $(_cmdline); do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
      A)
        _admin;
        ;;
      b)
        _base;
        ;;
      c)
        _cron;
        ;;
      i)
        _info;
        ;;
      l)
        _login;
        ;;
      L)
        _logsize;
        ;;
      m)
        _multi;
        ;;
      T)
        _truncate;
        ;;
      P)
        _password "$OPTARG";
        ;;
      u)
        _users;
        ;;
      x)
        _index;
        ;;
      p)
        _products;
        ;;
      o)
        _orders;
        ;;
      s)
        _shipment;
        ;;
      O)
        _cookie;
        ;;
      q)
        _quotes;
        ;;
      I)
        _invoices;
        ;;
      g)
        _categories;
        ;;
      C)
        _customers;
        ;;
      *);;
    esac
  done

  _cleanUp;

}

main;

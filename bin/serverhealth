#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

alias awk='/bin/awk'
alias cat='/bin/cat'
alias cut='/bin/cut'
alias df='/bin/df'
alias find='/bin/find'
alias grep='/bin/grep'
alias head='/usr/bin/head'
alias mysql='/usr/bin/mysql'
alias printf='/usr/bin/printf'
alias ps='/bin/ps'
alias sed='/bin/sed'
alias sort='/bin/sort'
alias test='/usr/bin/test'
alias true='/bin/true'
alias wc='/usr/bin/wc'


_usage() {
  cat <<- EOF
  This is the usage
EOF
}

_cmdline() {

  local x;

  for x in ${ARGA[*]}; do

    local delim=""

    case "$x" in
      "--help"|"-h")
        args="${args}-h "
        ;;
      "--queries"|"-q")
        args="${args}-q "
        ;;
      "--php"|"-p")
        args="${args}-p "
        ;;
      "--apache"|"-a")
        args="${args}-a "
        ;;
      "--memory"|"-m")
        args="${args}-m "
        ;;
      "--load"|"-l")
        args="${args}-l "
        ;;
      "--disk"|"-d")
        args="${args}-d "
        ;;
      "--services"|"-s")
        args="${args}-s "
        ;;
      *) [[ "${x:0:1}" == "-" ]] || delim="\"";
        args="${args}${delim}${x}${delim} "
        ;;
    esac

  done


  echo "$args";
}

_m () {

  mysql -u"$(grep '^rootdsn=' /usr/local/interworx/iworx.ini | cut -d/ -f3 | cut -d: -f1)" \
    -p"$(grep '^rootdsn=' /usr/local/interworx/iworx.ini | cut -d: -f3 | cut -d\@ -f1)" "$1"
}

_longrunqueries () {

  local count;

  count=$(_m -e'select count(*) from information_schema.PROCESSLIST where TIME>=10\G' 2> /dev/null \
    | sed -n 's/count(\*): \([0-9]*\).*/\1/p');

  if [ -n "$count" ] && [ "$count" -ge 10 ]; then
    echo "$count long running queries";
  fi

}

_maxphpprocs () {

  local phprocs numprocs users max;

  phprocs=$(ps -eo args \
    | awk '/^php-fpm: pool/ && $NF != "www"{  a[$NF] += 1 } END {for(i in a){ printf "%-10s %d\n",i,a[i] } }' \
    | sort -k2nr);

  numprocs=($(echo "$phprocs" | awk '{print $2}'));
  users=($(echo "$phprocs" | awk '{print $1}'));

  for ((x=0;x<"${#users[@]}";x++)); do

    max="$(find {/opt/nexcess/php*/root,}/etc/php-fpm.d/*.conf -name "${users[$x]}.conf" \
      -exec /bin/awk -F '=' '/^[^#;]*pm.max_children/{ gsub(/\ [^0-9]*$/,"",$2); gsub(/^\ */,"",$2); print $2  }' {} + \
      | head -n1)"

    if [ "${numprocs[$x]}" -ge "$max" ]; then
      echo "${users[$x]} at max children";
    elif [ "${numprocs[$x]}" -ge "$((9*max/10))" ]; then
      echo "${users[$x]} near max children";
    fi

  done

}

_maxclients () {

  local count max;

  count="$(( $(ps -Chttpd | wc -l ) -1 ))";
  max="$(sed -n 's/^[^#]*MaxClients\s*\([0-9]*\).*/\1/p' /etc/httpd/conf/httpd.conf | head -n1)";

  if [ "$count" -ge "$max" ]; then
    echo "Apache at MaxClients";
  elif [ $count -ge "$(( 9 * max / 10 ))" ]; then
    echo "Apache near MaxClients";
  fi

}

_memcheck () {

  local active total swptotal swpfree;

  active=$(sed -n 's/Active:\s*\([0-9]*\).*/\1/p' /proc/meminfo)
  total=$(sed -n 's/MemTotal:\s*\([0-9]*\).*/\1/p' /proc/meminfo)
  swptotal=$(sed -n 's/SwapTotal:\s*\([0-9]*\).*/\1/p' /proc/meminfo)
  swpfree=$(sed -n 's/SwapFree:\s*\([0-9]*\).*/\1/p' /proc/meminfo)

  if [ "$active" -ge "$((9 * total / 10))" ]; then
    echo "System memory low";
  fi
  if [ "$swpfree" -le "$((swptotal / 10))" ]; then
    echo "Swap low";
  fi

}

_loadavgchk () {

  local avgs cpucount;

  avgs=($(cut -d ' ' -f1-3 /proc/loadavg));

  avgs[0]=$(printf "%.*f\n" 0 "${avgs[0]}")
  avgs[1]=$(printf "%.*f\n" 0 "${avgs[1]}")
  avgs[2]=$(printf "%.*f\n" 0 "${avgs[2]}")


  cpucount="$(grep -c ^processor /proc/cpuinfo)"

  if [ "${avgs[0]}" -ge "$cpucount" ]; then
    echo "Load average high";
  fi
  if [ "${avgs[1]}" -ge "$cpucount" ]; then
    echo "5 min load average high";
  fi
  if [ "${avgs[2]}" -ge "$cpucount" ]; then
    echo "15 min load average high";
  fi

}

_partitioncheck () {

  df \
    | awk '!/Filesystem/ {gsub(/%/,"",$0); if($5 > 95){print $(NF)" partition "$5"% full"}}'

}

_checkservices () {

  local process_data configured_phps running_phps php_instances configured_httpd running_httpd configured_memcached \
    running_memcached memcached_instances configured_redis running_redis redis_instances configured_mysqld running_mysqld;

  process_data=$(ps -C redis-server,memcached,php-fpm,mysqld,httpd -o user,pid,cmd);

  configured_phps=($(find /etc/rc.d/rc3.d/ | grep -Po '...\Kphp.*fpm'));
  running_phps=($(echo "$process_data" | awk '/php-fpm.*master/ { gsub(/\(|\)/,"",$6); print $6}'));

  if [[ "${#configured_phps[@]}" != "${#running_phps[@]}" ]]; then

    php_instances=$(echo "$process_data" | grep -Po "php-fpm: master process \(\K.*" | sed -rn -e 's/.*(php[0-9]{2}u).*(php-fpm).*/\1-\2/p' -e 's/^\/etc\/(php-fpm).*/\1/p')

    for x in ${configured_phps[*]}; do

      if ! echo "$php_instances" | grep -qx "$x"; then
        echo "$x is DOWN";
      fi

    done

  fi

  configured_httpd=($(find /etc/rc.d/rc3.d/ | grep -Po '...\Khttpd'));
  running_httpd=($(echo "$process_data" | grep -Po "^root.*\Khttpd"));

  if [[ "${#configured_httpd[@]}" != "${#running_httpd[@]}" ]]; then
    echo "Apache is DOWN";
  fi

  configured_memcached=($(find /etc/sysconfig -mindepth 1 | grep -Po "/etc/sysconfig/memcached\.\K\S*"));
  running_memcached=($(echo "$process_data" | grep -Po "memcached\..*\.pid"));

  if [[ "${#configured_memcached[@]}" != "${#running_memcached[@]}" ]]; then

    memcached_instances="$(echo "$process_data" | grep -Po '\-P /var/tmp/memcached\.\K\S*(?=.pid)')"

    for x in ${configured_memcached[*]}; do
      if ! echo "$memcached_instances" | grep -q "$x"; then
        echo "Memcached instance $x is DOWN";
      fi
    done
  fi

  configured_redis=($(find /etc/redis-multi/ -mindepth 1 | grep -Po "multi_[a-z]*\.\K.*(?=.conf)"));
  running_redis=($(echo "$process_data" | grep -Po "^\S*(?=.*redis-server)" ));

  if [[ "${#configured_redis[@]}" != "${#running_redis[@]}" ]]; then

    redis_instances=$(lsof -U -ap"$(echo "$process_data" | awk 'BEGIN{ORS=",";} /redis-server/ {print $2}')" -Fn)

    for x in ${configured_redis[*]}; do

      if ! echo "$redis_instances" | grep -q "$x"; then
        echo "Redis instance $x is DOWN";
      fi

    done
  fi

  configured_mysqld=($(find /etc/rc.d/rc3.d/ | grep -Po '...\Kmysqld'));
  running_mysqld=($(echo "$process_data" | grep -Po "\S*mysqld "));

  if [[ "${#configured_mysqld[@]}" != "${#running_mysqld[@]}" ]]; then
    echo "MySQLd service is DOWN";
  fi

}

main () {

  while getopts "hqpamlds" OPTION "$(_cmdline)"; do

    case $OPTION in
      h)
        _usage;
        exit 0;
        ;;
      q)
        _longrunqueries;
        exit 0;
        ;;
      p)
        _maxphpprocs;
        exit 0;
        ;;
      a)
        _maxclients;
        exit 0;
        ;;
      m)
        _memcheck;
        exit 0;
        ;;
      l)
        _loadavgchk;
        exit 0;
        ;;
      d)
        _partitioncheck;
        exit 0;
        ;;
      s)
        _checkservices;
        exit 0;
        ;;
    esac

  done

  export -f _longrunqueries;
  export -f _maxphpprocs;
  export -f _maxclients;
  export -f _memcheck;
  export -f _loadavgchk;
  export -f _partitioncheck;
  export -f _checkservices;
  export -f _m;

  echo;

  parallel -- \
    _longrunqueries \
    _maxphpprocs \
    _maxclients \
    _memcheck \
    _loadavgchk \
    _partitioncheck \
    _checkservices;

  echo;

}

main;

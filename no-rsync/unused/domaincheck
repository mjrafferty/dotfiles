#! /bin/bash

readonly ARGS="$*"
readonly ARGA=("$@")

_usage() {
  cat <<- EOF
  This is the usage
EOF
}

main () {

  if [[ "$ARGS" =~ --help$|-h$ ]]; then
    _usage;
    return 0;
  fi

  local vhost x sub r_id accounts D V I S F;

  vhost="$(echo /etc/httpd/conf.d/vhost_[^0]*.conf)"; sub='';

  case ${ARGA[0]} in
    "-a")
      if [[ -n ${ARGA[1]} ]]; then
        sub=${ARGA[1]};
      else
        sub='';
      fi
      vhost="$(grep -l "$(getusr)" /etc/httpd/conf.d/vhost_[^0]*.conf)";
      ;;
    "-r")
      if [[ -z ${ARGA[1]} ]]; then
        read -rp "ResellerID: " r_id;
      else
        r_id=${ARGA[1]};
      fi;
      accounts=$(nodeworx -unc Siteworx -a listAccounts | awk "(\$5 ~ /^$r_id$/)"'{print $2}');
      vhost=$(for r_user in $accounts; do grep -l "$r_user" /etc/httpd/conf.d/vhost_[^0]*.conf; done | sort | uniq);
      ;;
  esac;


  printf " %-15s  %-15s  %3s  %3s  %s\n" " Server IP" " Live IP" "SSL" "FPM" " Domain"
  printf " %-15s  %-15s  %3s  %3s  %s\n" "$(dashes 15)" "$(dashes 15)" "---" "---" "$(dashes 44)"

  echo;
  for x in $vhost; do

    D=$(basename "$x" .conf | cut -d_ -f2);
    V=$(awk '/.irtual.ost/ {print $2}' "$x" | head -1 | cut -d: -f1);
    I=$(dig +short +time=1 +tries=1 ${sub}"$D" | grep -E '^[0-9]{1,3}\.' | head -1);
    S=$(if grep :443 "$x" &> /dev/null; then echo SSL; fi);
    F=$(if grep MAGE_RUN "$x" &> /dev/null; then echo FIX; fi);

    if [[ "$I" != "$V" ]]; then
      printf "${BRIGHT}${RED} %-15s  %-15s  %3s  %3s  %s${NORMAL}\n" "$V" "$I" "${S:- - }" "${F:- - }" "${sub}$D";
    else
      printf " %-15s  %-15s  %3s  %3s  %s\n" "$V" "$I" "${S:- - }" "${F:- - }" "${sub}$D";
    fi

  done;
  echo;
}

main;

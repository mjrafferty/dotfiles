#! /bin/bash

## Rewrite of Ted Wells sinfo

_phpversion(){

  phpv=$($1 -v | awk '/^PHP/ {print $2}');
  zend=$($1 -v | awk '/Engine/ {print "; "$1,$2" ("$3")"}' | sed 's/v//;s/,//');
  ionc=$($1 -v | awk '/ionCube/ {print "; "$3" ("$6")"}' | sed 's/v//;s/,//');
  eacc=$($1 -v | awk '/eAcc/ {print "; "$2" ("$3")"}' | sed 's/v//;s/,//');
  guard=$($1 -v | awk '/Guard/ {print "; "$2,$3" ("$5")"}' | sed 's/v//;s/,//');
  suhos=$($1 -v | awk '/Suhosin/ {print "; "$2" ("$3")"}' | sed 's/v//;s/,//');
  opche=$($1 -v | awk '/OPcache/ {print "; "$2,$3" ("$4")"}' | sed 's/v//;s/,//')

  if [[ -d /etc/php-fpm.d/ ]]; then
    phpt='php-fpm';
  else
    phpt=$(awk '/^LoadModule/ {print $2}' /etc/httpd/conf.d/php.conf /etc/httpd/conf.d/suphp.conf | sed 's/php[0-9]_module/mod_php/;s/_module//');
  fi;

  printf "%-14s: %s\n" "PHP Version" "${phpt} (${phpv})${zend}${ionc}${guard}${opche}${eacc}${suhos}";
}

echo;

printf "%-14s: %s\n" "Hostname" "$(serverName)"
printf "%-14s: %s\n" "OS (Kernel)" "$(awk '{print $1,$3}' < /etc/redhat-release ) ($(uname -r))"

ssl="$(openssl version | awk '{print $2}')"
web="$(curl -s -I "$(serverName)" | awk '/Server:/ {print $2}')";

if [[ -z $web ]]; then
  web="$(curl -s -I "$(serverName)":8080 | awk '/Server:/ {print $2}')";
fi

if [[ $web =~ Apache ]]; then
  webver=$(httpd -v | head -1 | awk '{print $3}' | sed 's:/: :');
elif [[ $web =~ LiteSpeed ]]; then
  webver=$(/usr/local/lsws/bin/lshttpd -v | sed 's:/: :');
elif [[ $web =~ nginx ]]; then
  webver=$(nginx -v 2>&1 | head -1 | awk '{print $3}' | sed 's:/: :');
fi

printf "%-14s: %s\n" "Web Server" "$webver; OpenSSL ($ssl)"

if [[ -f /etc/init.d/varnish ]]; then
  printf "%-14s: %s\n" "Varnish" "$(varnishd -V 2>&1 | awk -F- 'NR<2 {print $2}' | tr -d \))";
fi

_phpversion /usr/bin/php;

if [[ -f /opt/nexcess/php54u/root/usr/bin/php ]]; then

  for x in /opt/nexcess/*/root/usr/bin/php; do
    _phpversion "$x";
  done;

fi

modsecv=$(rpm -qi mod_security | awk '/Version/ {print $3}' 2> /dev/null)
modsecr=$(awk -F\" '/SecComp.*\"$/ {print "("$2")"}' /etc/httpd/modsecurity.d/*_crs_10_*.conf 2> /dev/null)

printf "%-14s: %s\n" "ModSecurity" "${modsecv:-No ModSecurity} ${modsecr}"
printf "%-14s: %s\n" "MySQL Version" "$(mysql --version | awk '{print $5}' | tr -d ,) $(mysqld --version 2> /dev/null | grep -io 'percona' 2> /dev/null)"

pstgrs="/usr/*/bin/postgres";

if [[ -f "$pstgrs" ]]; then
  printf "%-14s: %s\n" "PostgreSQL" "$($pstgrs -V | awk '{print $NF}')";
fi

printf "%-14s: %s\n" "Interworx" "$(grep -A1 'user="iworx"' /home/interworx/iworx.ini | tail -1 | cut -d\" -f2)"

if [[ $1 =~ -v ]]; then

  printf "%-14s: %s\n" "Rev. Control" "Git ($(git --version | awk '{print $3}')); SVN ($(svn --version | awk 'NR<2 {print $3}')); $(hg --version | awk 'NR<2 {print $1" ("$NF}')"

  perlv=$(perl -v | awk '/v[0-9]/ {print "Perl ("$4")"}' | sed 's/v//')
  pythv=$(python -V 2>&1 | awk '{print $1" ("$2")"}')
  rubyv=$(ruby -v | awk '{print "Ruby ("$2")"}')
  railv=$(if [[ ! $(which rails 2>&1) =~ /which ]]; then rails -v | awk '{print $1" ("$2")"}'; fi)

  printf "%-14s: %s\n" "Script Langs" "${perlv}; ${pythv}; ${rubyv}; ${railv:-No Rails}"
  printf "%-14s: %s\n" "FTP/sFTP/SSH" "ProFTPD ($(proftpd --version | awk '{print $3}')); OpenSSH ($(ssh -V 2>&1 | cut -d, -f1 | awk -F_ '{print $2}'))";

fi

printf "\n%-14s: %s\n" "CPUs (Type)" "$(awk '/model name/{print $4,$5,$7,$9,$10}' /proc/cpuinfo | uniq -c | awk '{print $1,"- "$2,$3" - "$4,$5,$6}')"
printf "%-14s: %s\n" "Memory (RAM)" "$(free -m | awk '/Mem/ {print ($2/1000)"G / "($4/1000)"G ("($4/$2*100)"% Free)"}')"
printf "%-14s: %s\n" "Memory (Swap)" "$(if [[ $(free -m | awk '/Swap/ {print $2}') != 0 ]]; then free -m | awk '/Swap/ {print ($2/1000)"G / "($4/1000)"G ("($4/$2*100)"% Free)"}'; else echo 'No Swap'; fi)"
printf "%-14s: %s\n" "HDD (/home)" "$(df -h /home | tail -1 | awk '{print $2" / "$4" ("($4/$2*100)"% Free)"}')"
echo
